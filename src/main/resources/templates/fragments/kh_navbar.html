<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<style>
  /* Tối ưu navbar */
  .navbar .container {
    flex-wrap: nowrap;
    /* Ngăn xuống dòng */
    gap: 0.5rem;
    /* Khoảng cách nhỏ giữa các phần tử */
  }

  /* Đảm bảo navbar hoạt động đúng */
  .navbar {
    position: sticky !important;
    top: 0 !important;
    margin-bottom: 0 !important;
    margin-top: 0 !important;
    padding: 0 !important;
    z-index: 1040 !important;
    /* Navbar sẽ cố định khi cuộn */
  }

  /* Logo */
  .navbar-logo {
    flex: 0 0 auto;
    font-size: 1.5rem;
    /* Kích thước logo */
  }

  /* Nút tìm kiếm trên mobile */
  .navbar-search-btn {
    flex: 0 0 auto;
    padding: 0.25rem 0.5rem;
  }

  /* Khu vực người dùng */
  .navbar-user {
    flex: 0 0 auto;
    gap: 0.5rem !important;
  }

  /* Icon giỏ hàng và người dùng */
  .navbar-user .fs-5 {
    font-size: 1.25rem !important;
  }

  /* Nút đăng nhập/người dùng */
  .navbar-user .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }

  .navbar-user .btn.rounded-circle {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* FIX: Dropdown menu z-index và position */
  .navbar-user .dropdown {
    position: relative !important;
    z-index: 1080 !important;
  }

  .navbar-user .dropdown-menu {
    position: absolute !important;
    z-index: 10000 !important;
    top: 100% !important;
    right: 0 !important;
    left: auto !important;
    min-width: 200px;
    margin-top: 0.25rem;
    border: 1px solid rgba(0, 0, 0, 0.15);
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.175);
    background-color: #fff !important;
  }

  /* Đảm bảo dropdown menu hiển thị đúng */
  .navbar-user .dropdown-menu.show {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
    transform: translateY(0) !important;
  }

  /* Overlay để đảm bảo dropdown luôn ở trên cùng */
  .dropdown-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1045;
    background: transparent;
  }

  #searchModal .form-control {
    font-size: 1rem;
    padding: 0.5rem 1rem;
  }

  /* Search Modal z-index */
  #searchModal {
    z-index: 1055 !important;
  }

  #searchModal .modal-dialog {
    z-index: 1056 !important;
  }

  /* Mobile-specific */
  @media (max-width: 767px) {
    .navbar-logo {
      font-size: 1.25rem;
      /* Logo nhỏ hơn */
    }

    /* Smaller logo on mobile */
    .navbar-logo img {
      height: 28px;
    }

    .navbar-search-btn .fs-5 {
      font-size: 1.25rem !important;
      /* Icon tìm kiếm */
    }

    .navbar-user .fs-5 {
      font-size: 1rem !important;
      /* Icon giỏ hàng */
    }

    .navbar-user .badge {
      font-size: 0.625rem;
      padding: 0.25em 0.4em;
    }

    .navbar-user .btn.rounded-circle {
      width: 28px;
      height: 28px;
    }

    /* Mobile dropdown adjustments */
    .navbar-user .dropdown-menu {
      min-width: 180px;
      right: -10px !important;
    }
  }

  /* Màn hình rất nhỏ */
  @media (max-width: 576px) {
    .navbar-logo {
      font-size: 1rem;
    }

    /* Even smaller logo on very small screens */
    .navbar-logo img {
      height: 24px;
    }

    #searchModal .form-control {
      font-size: 0.875rem;
    }

    /* Very small screen dropdown */
    .navbar-user .dropdown-menu {
      right: -15px !important;
      min-width: 160px;
    }
  }
</style>

<body>
  <th:block th:fragment="navbar(user, keyword, cartCount)">
    <nav class="navbar navbar-expand-lg shadow-sm mb-0 w-100 sticky-top"
      style="background: linear-gradient(135deg, #000000 0%, #333333 100%); margin: 0; padding: 0; top: 0; left: 0; right: 0; z-index: 1050;">
      <div class="container d-flex align-items-center py-2">
        <!-- Logo -->
        <a class="navbar-logo text-white text-decoration-none fw-bold d-flex align-items-center" href="/">
          <span class="d-none d-md-inline">Poly Shoes Store</span>
        </a>

        <!-- Nút tìm kiếm - Hiển thị trên mobile -->
        <div class="navbar-search-btn d-lg-none ms-auto me-2">
          <button class="btn text-white fs-5 p-1" data-bs-toggle="modal" data-bs-target="#searchModal" title="Tìm kiếm">
            <i class="fas fa-search"></i>
            <span class="visually-hidden">Tìm kiếm</span>
          </button>
        </div>

        <!-- Giỏ hàng + Người dùng -->
        <div class="navbar-user d-flex align-items-center gap-2">
          <!-- Giỏ hàng -->
          <a th:href="@{/cart}" class="text-white fs-5 position-relative" aria-label="Giỏ hàng">
            <i class="fas fa-shopping-cart"></i>
            <span id="cart-count"
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              th:text="${cartCount != null} ? ${cartCount} : 0">0</span>
          </a>

          <!-- Nếu đã đăng nhập -->
          <div th:if="${user != null}" class="dropdown">
            <button class="btn text-white fw-semibold dropdown-toggle d-none d-lg-block" type="button"
              data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
              <i class="fas fa-user-circle me-1"></i> <span th:text="${user.hoTen}">Tên người dùng</span>
            </button>
            <button class="btn text-white d-lg-none" type="button" data-bs-toggle="dropdown" aria-expanded="false"
              title="Tài khoản" data-bs-auto-close="outside">
              <i class="fas fa-user-circle"></i>
              <span class="visually-hidden">Tài khoản</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" th:href="@{/profile}"><i class="fas fa-user me-2"></i>Tài khoản của tôi</a>
              </li>
              <li><a class="dropdown-item" th:href="@{/dsdon-mua}"><i class="fas fa-shopping-bag me-2"></i>Đơn mua</a>
              </li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item text-danger" th:href="@{/customers/logout}"><i
                    class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
            </ul>
          </div>

          <!-- Nếu chưa đăng nhập -->
          <a th:if="${user == null}" th:href="@{/customers/login}"
            class="btn btn-light fw-semibold rounded-pill px-3 d-none d-lg-block" id="loginButton">
            Đăng nhập
          </a>
          <a th:if="${user == null}" th:href="@{/customers/login}" class="btn btn-light rounded-circle px-2 d-lg-none"
            id="loginButtonMobile">
            <i class="fas fa-sign-in-alt"></i>
          </a>
        </div>
      </div>
    </nav>

    <!-- Modal tìm kiếm (hiển thị trên mobile) -->
    <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-lg">
          <div class="modal-header text-white">
            <h5 class="modal-title" id="searchModalLabel">Tìm kiếm sản phẩm</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">
            <form id="modalSearchForm" action="/search" method="get">
              <div class="input-group">
                <input type="text" class="form-control rounded-start-pill border-0" placeholder="Tìm kiếm sản phẩm..."
                  name="keyword" id="modalSearchInput" autocomplete="off">
                <button class="btn btn-light rounded-end-pill px-4" type="submit">
                  <i class="fas fa-search text-blue-800"></i>
                </button>
              </div>
              <div id="modalSearchSuggestions" class="search-suggestions mt-2"></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </th:block>

  <!-- Script để đảm bảo dropdown hoạt động tốt -->
  <th:block th:fragment="navbarScripts">
    <script>
      // Đảm bảo dropdown hoạt động đúng
      document.addEventListener('DOMContentLoaded', function () {
        // Xử lý dropdown với positioning tốt hơn
        const dropdownElements = document.querySelectorAll('.dropdown-toggle');
        dropdownElements.forEach(function (dropdown) {
          dropdown.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            const dropdownMenu = this.nextElementSibling;
            const isOpen = dropdownMenu.classList.contains('show');

            // Đóng tất cả dropdown khác
            document.querySelectorAll('.dropdown-menu.show').forEach(function (menu) {
              menu.classList.remove('show');
              menu.parentElement.classList.remove('show');
            });

            // Toggle dropdown hiện tại
            if (!isOpen) {
              // Tính toán vị trí
              const rect = dropdown.getBoundingClientRect();
              const navbarHeight = document.querySelector('.navbar').offsetHeight;

              // Đặt position cho dropdown
              dropdownMenu.style.position = 'fixed';
              dropdownMenu.style.top = (rect.bottom + 5) + 'px';
              dropdownMenu.style.right = (window.innerWidth - rect.right) + 'px';
              dropdownMenu.style.zIndex = '99999';

              dropdownMenu.classList.add('show');
              dropdown.closest('.dropdown').classList.add('show');

              // Tự động đóng khi click ra ngoài
              document.addEventListener('click', function closeDropdown(event) {
                if (!dropdown.contains(event.target) && !dropdownMenu.contains(event.target)) {
                  dropdownMenu.classList.remove('show');
                  dropdown.closest('.dropdown').classList.remove('show');
                  document.removeEventListener('click', closeDropdown);
                }
              });
            }
          });
        });

        // Ngăn dropdown đóng khi click vào các item
        document.querySelectorAll('.dropdown-menu').forEach(function (menu) {
          menu.addEventListener('click', function (e) {
            e.stopPropagation();
          });
        });

        // Đóng dropdown khi resize màn hình
        window.addEventListener('resize', function () {
          document.querySelectorAll('.dropdown-menu.show').forEach(function (menu) {
            menu.classList.remove('show');
            menu.parentElement.classList.remove('show');
          });
        });
      });
    </script>
    <script src="/js/navbar.js"></script>
  </th:block>
</body>

</html>