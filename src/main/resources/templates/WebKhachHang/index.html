<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PolyShoes - Trang chủ</title>
  <link rel="icon" href="/image/Poly Store.png" type="image/png" sizes="32x32" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    integrity="sha512-Avb2QiuDEEvB4bZJYdft2mNjVShBftLdPG8FJ0V7irTLQ8Uo0qcPxh4Plq7G5tGm0rU+1SPhVotteLpBERwTkw=="
    crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/css/black-white-red-theme.css" />
  <style>
    /* Messenger FAB (nút mở Messenger) */
    .messenger-fab {
      position: fixed;
      bottom: 92px;
      /* = 20px (chatbot) + 60px (nút) + 12px khoảng cách */
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #0084FF;
      /* màu Messenger */
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .25);
      z-index: 10001;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease;
    }

    .messenger-fab:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, .3);
    }

    .messenger-fab i {
      font-size: 28px;
    }

    @media (max-width: 640px) {
      .messenger-fab {
        bottom: 90px;
        right: 16px;
        width: 56px;
        height: 56px;
      }
    }

    .navbar {
      background: linear-gradient(135deg, #153054 0%, #1e4066 100%);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .badge-new {
      background-color: #153054;
    }

    /* Size chip */
    .size-option {
      padding: 8px 16px;
      border: 2px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .size-option.active {
      background: #153054;
      color: #fff;
      border-color: #153054;
    }

    /* Swatch tròn khi có mã màu (data-swatch="true") */
    .color-option[data-swatch="true"] {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid #ccc;
      /* <- đồng bộ viền với size */
      padding: 0;
      cursor: pointer;
      transition: .3s;
    }

    .color-option[data-swatch="true"].active {
      border-color: #153054;
    }

    /* Màu dạng chữ (không có mã màu) – giống hệt size */
    .color-option:not([data-swatch="true"]) {
      padding: 8px 16px;
      border: 2px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .color-option:not([data-swatch="true"]).active {
      background: #153054;
      color: #fff;
      border-color: #153054;
    }

    .swiper-slide img {
      object-fit: cover;
      height: 500px;
      width: 100%;
    }

    /* Modern Hero Banner Styling */
    .hero-banner {
      margin-bottom: 2rem;
    }

    .hero-banner .swiper-slide {
      height: 600px;
    }

    .hero-banner .swiper-button-next,
    .hero-banner .swiper-button-prev {
      background-color: rgba(255, 255, 255, 0.2);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      transition: all 0.3s ease;
    }

    .hero-banner .swiper-button-next:hover,
    .hero-banner .swiper-button-prev:hover {
      background-color: rgba(255, 255, 255, 0.4);
    }

    .hero-banner .swiper-button-next:after,
    .hero-banner .swiper-button-prev:after {
      font-size: 18px;
    }

    /* Accessibility - Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    .hero-banner .swiper-pagination-bullet {
      width: 10px;
      height: 10px;
      background-color: rgba(255, 255, 255, 0.7);
      opacity: 0.7;
    }

    .hero-banner .swiper-pagination-bullet-active {
      background-color: #ffffff;
      opacity: 1;
    }

    @media (max-width: 768px) {
      .hero-banner .swiper-slide {
        height: 500px;
      }
    }

    @media (max-width: 640px) {
      .hero-banner .swiper-slide {
        height: 400px;
      }

      .hero-banner .container .text-white {
        padding: 0 1rem;
        max-width: 90%;
      }

      .hero-banner .text-3xl {
        font-size: 1.5rem;
      }

      .action-group {
        opacity: 1;
        transform: none;
      }

      .product-card .action-btn {
        width: 36px;
        height: 36px;
      }

      .modal-product-info {
        flex-direction: column;
        align-items: flex-start;
      }

      .modal-product-info img {
        margin-bottom: 1rem;
      }

      .size-options,
      .color-options {
        gap: 0.5rem;
      }

      #mini-tabs {
        overflow-x: auto;
      }

      section {
        padding-left: 1rem;
        padding-right: 1rem;
      }

      .product-grid {
        gap: 0.75rem;
      }
    }

    /* Ensure text readability on mobile */
    @media (max-width: 480px) {
      .hero-banner .text-3xl {
        font-size: 1.25rem;
      }

      .hero-banner p {
        font-size: 0.875rem;
      }

      .hero-banner a {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }
    }

    .ticker {
      background-color: #9FD5F7;
      color: #153054;
      font-weight: bold;
      position: relative;
      width: 100%;
      z-index: 1050;
    }

    .navbar {
      position: sticky;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1040;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      min-width: 200px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      z-index: 1000;
      padding: 8px;
    }

    .dropdown:hover .dropdown-menu {
      display: block;
      animation: fadeInUp 0.3s ease;
    }

    body {
      padding-top: 0;
      margin: 0;
    }

    .user-info {
      display: none;
      color: white;
    }

    .user-info.active {
      display: inline;
    }

    /* Ẩn mặc định bằng opacity + transform (để transition mượt) */


    #confirmAddToCart.loading::after {
      content: '';
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid white;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #back-to-top {
      transition: opacity 0.3s;
    }

    #back-to-top.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      max-height: 300px;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .search-suggestions.active {
      opacity: 1;
      visibility: visible;
    }

    .suggestion-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
    }

    .suggestion-item:hover {
      background-color: #f1f5f9;
    }

    .suggestion-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      margin-right: 10px;
      border-radius: 4px;
    }

    .history-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
      background-color: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .history-item:hover {
      background-color: #e2e8f0;
    }

    .history-item .highlight {
      background-color: #9FD5F7;
      padding: 2px 4px;
      border-radius: 4px;
    }

    .history-item .delete-btn {
      color: #ef4444;
      font-size: 14px;
      cursor: pointer;
      padding: 5px;
      transition: color 0.2s;
    }

    .history-item .delete-btn:hover {
      color: #b91c1c;
    }

    @media (max-width: 640px) {
      #chatbot-box {
        width: 92vw;
        right: 4vw;
        bottom: 90px;
        /* tránh đè nút nổi */
        height: 70vh;
      }
    }

    /* Active tab */
    #mini-tabs .tab-link.is-active {
      color: #153054;
      background: #E8F2FF;
    }

    /* Ẩn scrollbar ngang tabs (mobile) */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .cat-chip.active {
      border-color: #153054;
      background: #E8F2FF;
      color: #153054;
    }

    /* vì có thêm 2 thanh sticky (mini-tabs + categories), tăng offset khi scroll tới section */
    #section-new,
    #section-all,
    #section-best {
      scroll-margin-top: 120px;
    }

    /* Product Card Styling */
    :root {
      --acv-blue: #153054;
      --card-r: 14px;
    }

    .product-card {
      position: relative;
      border: 1px solid #e5edf6;
      border-radius: var(--card-r);
      background: #fff;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(21, 48, 84, .06);
      transition: transform .25s, box-shadow .25s;
    }

    .product-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 16px 32px rgba(21, 48, 84, .15);
    }

    .product-media {
      position: relative;
      aspect-ratio: 1/1;
      background: #f6f7fb;
      overflow: hidden;
    }

    .product-media img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scale(1.02);
      transition: transform .6s ease;
    }

    .product-card:hover .product-media img {
      transform: scale(1.08);
    }

    .badge-new {
      background: #10b981;
      color: #fff;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .7rem;
      font-weight: 700;
      box-shadow: 0 8px 16px rgba(0, 0, 0, .2);
    }

    .badge-hot {
      background: #ef4444;
      color: #fff;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .7rem;
      font-weight: 700;
      box-shadow: 0 8px 16px rgba(0, 0, 0, .2);
    }

    .action-group {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 3;
      opacity: 0;
      transform: translateX(6px);
      transition: all .25s ease;
    }

    .product-card:hover .action-group {
      opacity: 1;
      transform: none;
    }

    .action-btn {
      background: #fff;
      border: 0;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(21, 48, 84, .25);
    }

    .action-btn:hover {
      background: #e8f1fb;
    }

    .product-body {
      padding: 12px 14px;
    }

    .product-title {
      font-weight: 600;
      color: #1f2937;
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 42px;
    }
  </style>
</head>

<body class="bg-gray-100">


  <div th:replace="~{fragments/kh_navbar :: navbar(user=${user}, keyword=${keyword}, cartCount=${cartCount})}"></div>

  <!-- Modern Main Navigation Tabs
  <nav id="mini-tabs" class="bg-white sticky top-[40px] z-[1039] shadow-sm">
    <div class="container mx-auto">
      <ul class="flex items-center justify-end gap-2 sm:gap-4 overflow-x-auto no-scrollbar px-3 sm:px-0 relative">
        <li>
          <a href="#section-new"
            class="tab-link inline-flex items-center gap-2 px-4 py-4 text-sm font-semibold text-gray-700 hover:text-red-600 transition-colors duration-300 border-b-2 border-transparent">
            <span>Mới</span>
          </a>
        </li>
        <li>
          <a href="#section-all"
            class="tab-link inline-flex items-center gap-2 px-4 py-4 text-sm font-semibold text-gray-700 hover:text-red-600 transition-colors duration-300 border-b-2 border-transparent">
            <span>Tất cả</span>
          </a>
        </li>
        <li>
          <a href="#section-best"
            class="tab-link inline-flex items-center gap-2 px-4 py-4 text-sm font-semibold text-gray-700 hover:text-red-600 transition-colors duration-300 border-b-2 border-transparent">
            <span>Bán chạy</span>
          </a>
        </li> -->

  <!-- Custom indicator that will be controlled by JavaScript -->
  <span id="tab-indicator"
    class="absolute bottom-0 h-[3px] bg-red-600 rounded-t transition-all duration-300 ease-out"></span>
  </ul>
  </div>
  </nav>

  <!-- Category navigation has been moved to the left side and will be part of the main layout -->

  <!-- Modern Add to Cart Modal -->
  <div class="modal fade" id="addToCartModal" tabindex="-1" aria-labelledby="addToCartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-xl shadow-lg border-0">
        <!-- Modal Header with Custom Design -->
        <div class="modal-header bg-black text-white py-4 px-5 border-0 rounded-t-xl">
          <h5 class="modal-title text-lg font-bold" id="addToCartModalLabel">
            Thêm vào giỏ hàng
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body p-6">
          <!-- Product Info with Enhanced Layout -->
          <div class="modal-product-info flex items-center gap-5 pb-5 border-b border-gray-100">
            <div class="w-24 h-24 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
              <img id="modalProductImage" src="" alt="Product Image" class="w-full h-full object-cover">
            </div>
            <div>
              <h6 id="modalProductName" class="font-bold text-gray-800 text-lg mb-1"></h6>
              <p id="modalProductPrice" class="text-red-600 font-bold text-xl"></p>
              <p id="modalProductStock" class="text-sm text-gray-600 mt-1">
                <span>Tồn kho: 20</span>
              </p>
            </div>
          </div>

          <!-- Size Selection with Better Visualization -->
          <div class="size-selection mt-5">
            <h6 class="font-semibold text-gray-700 mb-3">
              Chọn size:
            </h6>
            <div class="size-options flex flex-wrap gap-2 mt-2" id="modalSizeOptions"></div>
          </div>

          <!-- Color Selection with Better Visualization -->
          <div class="color-selection mt-5">
            <h6 class="font-semibold text-gray-700 mb-3">
              Chọn màu sắc:
            </h6>
            <div class="color-options flex flex-wrap gap-2 mt-2" id="modalColorOptions"></div>
          </div>

          <!-- Quantity Selection with Enhanced Controls -->
          <div class="quantity-selection mt-5">
            <h6 class="font-semibold text-gray-700 mb-3">
              Số lượng:
            </h6>
            <div class="quantity-control flex items-center gap-3 mt-2">
              <button
                class="quantity-btn minus w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors duration-200"
                aria-label="Giảm số lượng" title="Giảm số lượng">
                -
              </button>
              <input type="number" value="1" min="1" step="1"
                class="quantity-input w-16 h-10 text-center border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-300">
              <button
                class="quantity-btn plus w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors duration-200"
                aria-label="Tăng số lượng" title="Tăng số lượng">
                +
              </button>
            </div>

            <!-- Quantity Error Message -->
            <div id="qtyError" class="text-red-500 text-sm mt-2 hidden flex items-center" role="alert"
              aria-live="assertive">
              <span>Số lượng vượt quá tồn kho</span>
            </div>
          </div>

          <!-- Error Message -->
          <div id="modalError" class="text-red-500 text-sm mt-4 hidden bg-red-50 p-3 rounded-lg">
            <span>Vui lòng chọn kích thước và màu sắc!</span>
          </div>
        </div>

        <!-- Footer with Enhanced Buttons -->
        <div class="modal-footer border-0 gap-3 p-4">
          <button type="button" class="btn btn-light rounded-lg border px-4 py-2 hover:bg-gray-100"
            data-bs-dismiss="modal">
            Đóng
          </button>
          <button type="button"
            class="btn bg-red-600 text-white rounded-lg px-5 py-2 hover:bg-red-700 transition-colors duration-200"
            id="confirmAddToCart">
            Thêm vào giỏ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hero Banner Section with Modern Design -->
  <div class="mt-5 hero-banner relative overflow-hidden bg-gradient-to-r from-gray-900 to-black mb-8">
    <div class="swiper banner-slider">
      <div class="swiper-wrapper">
        <div class="swiper-slide relative">
          <div class="absolute inset-0 bg-gradient-to-r from-black/70 to-transparent z-10"></div>
          <img loading="lazy" src="/image/banner1.jpg" alt="Banner thời trang nam" class="w-full h-full object-cover" />
          <div class="container mx-auto absolute inset-0 flex items-center z-20">
            <div class="text-white max-w-lg px-6 md:px-0">
              <h2 class="text-3xl md:text-4xl font-bold mb-3 animate__animated animate__fadeInUp">Bộ Sưu Tập Mới</h2>
              <p class="text-gray-200 mb-6 animate__animated animate__fadeInUp animate__delay-1s">Khám phá các xu hướng
                mới nhất với thiết kế độc quyền tại Poly Shoe Store</p>
              <a href="/new"
                class="inline-block bg-white text-black px-6 py-3 rounded-md font-semibold hover:bg-gray-100 transition duration-300 animate__animated animate__fadeInUp animate__delay-2s">Khám
                phá ngay</a>
            </div>
          </div>
        </div>
        <div class="swiper-slide relative">
          <div class="absolute inset-0 bg-gradient-to-r from-black/70 to-transparent z-10"></div>
          <img loading="lazy" src="/image/banner2.jpg" alt="Banner khuyến mãi" class="w-full h-full object-cover" />
          <div class="container mx-auto absolute inset-0 flex items-center z-20">
            <div class="text-white max-w-lg px-6 md:px-0">
              <h2 class="text-3xl md:text-4xl font-bold mb-3 animate__animated animate__fadeInUp">Khuyến Mãi Đặc Biệt
              </h2>
              <p class="text-gray-200 mb-6 animate__animated animate__fadeInUp animate__delay-1s">Giảm giá lên đến 50%
                cho các sản phẩm hot nhất mùa này</p>
              <a href="/bestsellers"
                class="inline-block bg-white text-black px-6 py-3 rounded-md font-semibold hover:bg-gray-100 transition duration-300 animate__animated animate__fadeInUp animate__delay-2s">Mua
                ngay</a>
            </div>
          </div>
        </div>
        <div class="swiper-slide relative">
          <div class="absolute inset-0 bg-gradient-to-r from-black/70 to-transparent z-10"></div>
          <img loading="lazy" src="/image/banner3.jpg" alt="Banner khuyến mãi" class="w-full h-full object-cover" />
          <div class="container mx-auto absolute inset-0 flex items-center z-20">
            <div class="text-white max-w-lg px-6 md:px-0">
              <h2 class="text-3xl md:text-4xl font-bold mb-3 animate__animated animate__fadeInUp">Bộ Sưu Tập Giới Hạn
              </h2>
              <p class="text-gray-200 mb-6 animate__animated animate__fadeInUp animate__delay-1s">Đẳng cấp và phong cách
                với các thiết kế độc quyền</p>
              <a href="/all"
                class="inline-block bg-white text-black px-6 py-3 rounded-md font-semibold hover:bg-gray-100 transition duration-300 animate__animated animate__fadeInUp animate__delay-2s">Xem
                ngay</a>
            </div>
          </div>
        </div>
      </div>
      <div class="swiper-button-next text-white"></div>
      <div class="swiper-button-prev text-white"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>

  <!-- Main Content Layout with Left Sidebar -->
  <div class="container mx-auto mb-12">
    <div class="main-content-with-sidebar">
      <!-- Categories Left Sidebar -->
      <aside class="categories-sidebar sticky top-[88px] max-h-[calc(100vh-100px)] overflow-y-auto shadow-sm">
        <h3 class="font-bold text-lg mb-4 pb-2 border-b border-gray-200">Danh mục</h3>
        <div class="flex flex-col gap-2">
          <a th:each="c : ${categories}" th:href="@{/category/{id}(id=${c.id})}"
            th:classappend="${currentCategoryId == c.id} ? ' active' : ''" th:attr="data-name=${c.tenDanhMuc}"
            class="cat-chip text-sm font-medium border border-gray-200 bg-white text-gray-700 transition-all duration-200 hover:shadow">
            <span th:text="${c.tenDanhMuc}">Danh mục</span>
          </a>
        </div>
      </aside>

      <!-- Right Side Content -->
      <div class="product-sections">
        <!-- Modern Product Sections -->
        <!-- New Products Section -->
        <section id="section-new" class="mb-12">
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <!-- Section Header -->
            <div class="flex items-end justify-between border-b border-gray-100 p-6">
              <div class="relative">
                <h2 class="text-3xl font-bold text-gray-800">Sản phẩm mới</h2>
                <div class="absolute -bottom-6 left-0 w-24 h-1 bg-red-500 rounded-full"></div>
                <p class="text-sm text-gray-500 mt-1">Những item vừa cập bến — bắt trend ngay!</p>
              </div>

            </div>

            <!-- Products Grid -->
            <div class="p-6">
              <div class="product-grid grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <div class="product-card" th:each="product : ${newProducts}">
                  <div class="product-media">
                    <a th:href="@{/chitietsanpham(id=${product.id})}">
                      <img th:src="${product.urlHinhAnh}" th:alt="'Hình ảnh sản phẩm ' + ${product.tenSanPham}"
                        loading="lazy" th:title="${product.tenSanPham}" />
                    </a>

                    <div class="absolute top-3 left-3 z-10">
                      <span
                        class="badge-new inline-block px-3 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider">New</span>
                    </div>

                    <div class="action-group">
                      <button class="action-btn cart-icon" th:attr="
                            data-product-id=${product.id},
                            data-product-name=${product.tenSanPham},
                            data-product-price=${product.price},
                            data-product-img=${product.urlHinhAnh},
                            data-kich-co=${@jacksonObjectMapper.writeValueAsString(product.kichCoList)},
                            data-mau-sac=${@jacksonObjectMapper.writeValueAsString(product.mauSacList)},
                            data-stock=${product.tongSoLuong},
                            title='Thêm vào giỏ hàng',
                            aria-label='Thêm vào giỏ hàng'">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="sr-only">Thêm vào giỏ hàng</span>
                      </button>
                      <button class="action-btn quick-view-btn" th:attr="
                            data-product-id=${product.id},
                            title='Xem nhanh sản phẩm',
                            aria-label='Xem nhanh sản phẩm'">
                        <i class="fas fa-eye"></i>
                        <span class="sr-only">Xem nhanh sản phẩm</span>
                      </button>
                    </div>
                  </div>

                  <div class="product-body">
                    <a th:href="@{/chitietsanpham(id=${product.id})}">
                      <h3 th:text="${product.tenSanPham}" class="product-title"></h3>
                      <div class="price font-bold mt-2">
                        <span
                          th:text="${#numbers.formatDecimal(product.oldPrice, 1, 'COMMA', 0, 'POINT') + ' VNĐ'}">2.000.000
                          VNĐ</span>
                      </div>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- All Products Section -->
        <section id="section-all" class="mb-12">
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <!-- Section Header -->
            <div class="flex items-end justify-between border-b border-gray-100 p-6">
              <div class="relative">
                <h2 class="text-3xl font-bold text-gray-800">Tất cả sản phẩm</h2>
                <div class="absolute -bottom-6 left-0 w-24 h-1 bg-red-500 rounded-full"></div>
                <p class="text-sm text-gray-500 mt-1">Khám phá toàn bộ danh mục tại Poly Shoe Store</p>
              </div>
              <a href="/all"
                class="inline-flex items-center gap-2 px-5 py-2 bg-gray-50 text-black font-semibold rounded-full hover:bg-gray-100 transition duration-300">
                Xem tất cả
              </a>
            </div>

            <!-- Products Grid -->
            <div class="p-6">
              <div class="product-grid grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <div class="product-card" th:each="product : ${allProducts}">
                  <div class="product-media">
                    <a th:href="@{/chitietsanpham(id=${product.id})}">
                      <img th:src="${product.urlHinhAnh}" th:alt="'Hình ảnh sản phẩm ' + ${product.tenSanPham}"
                        loading="lazy" th:title="${product.tenSanPham}" />
                    </a>

                    <div class="action-group">
                      <button class="action-btn cart-icon" th:attr="
                            data-product-id=${product.id},
                            data-product-name=${product.tenSanPham},
                            data-product-price=${product.price},
                            data-product-img=${product.urlHinhAnh},
                            data-kich-co=${@jacksonObjectMapper.writeValueAsString(product.kichCoList)},
                            data-mau-sac=${@jacksonObjectMapper.writeValueAsString(product.mauSacList)},
                            data-stock=${product.tongSoLuong},
                            title='Thêm vào giỏ hàng',
                            aria-label='Thêm vào giỏ hàng'">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="sr-only">Thêm vào giỏ hàng</span>
                      </button>
                      <button class="action-btn quick-view-btn" th:attr="
                            data-product-id=${product.id},
                            title='Xem nhanh sản phẩm',
                            aria-label='Xem nhanh sản phẩm'">
                        <i class="fas fa-eye"></i>
                        <span class="sr-only">Xem nhanh sản phẩm</span>
                      </button>
                    </div>
                  </div>

                  <div class="product-body">
                    <a th:href="@{/chitietsanpham(id=${product.id})}">
                      <h3 th:text="${product.tenSanPham}" class="product-title"></h3>
                      <div class="price font-bold mt-2">
                        <span
                          th:text="${#numbers.formatDecimal(product.oldPrice, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">2.000.000
                          VNĐ</span>
                      </div>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Bestseller Products Section -->
        <section id="section-best" class="mb-12">
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <!-- Section Header -->
            <div class="flex items-end justify-between border-b border-gray-100 p-6">
              <div class="relative">
                <h2 class="text-3xl font-bold text-gray-800">Sản phẩm bán chạy</h2>
                <div class="absolute -bottom-6 left-0 w-24 h-1 bg-red-500 rounded-full"></div>
                <p class="text-sm text-gray-500 mt-1">Top pick được săn nhiều nhất thời gian qua</p>
              </div>
            </div>

            <!-- Products Grid -->
            <div class="p-6">
              <div class="product-grid grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <div class="product-card" th:each="product : ${bestsellerProducts}">
                  <div class="product-media">
                    <a th:href="@{/chitietsanpham(id=${product.id})}">
                      <img th:src="${product.urlHinhAnh}" th:alt="'Hình ảnh sản phẩm ' + ${product.tenSanPham}"
                        loading="lazy" th:title="${product.tenSanPham}" />
                    </a>

                    <div class="absolute top-3 left-3 z-10">
                      <span
                        class="badge-hot inline-block px-3 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider">Hot</span>
                    </div>

                    <div class="action-group">
                      <button class="action-btn cart-icon" th:attr="
                            data-product-id=${product.id},
                            data-product-name=${product.tenSanPham},
                            data-product-price=${product.price},
                            data-product-img=${product.urlHinhAnh},
                            data-kich-co=${@jacksonObjectMapper.writeValueAsString(product.kichCoList)},
                            data-mau-sac=${@jacksonObjectMapper.writeValueAsString(product.mauSacList)},
                            data-stock=${product.tongSoLuong},
                            title='Thêm vào giỏ hàng',
                            aria-label='Thêm vào giỏ hàng'">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="sr-only">Thêm vào giỏ hàng</span>
                      </button>
                      <button class="action-btn quick-view-btn" th:attr="
                            data-product-id=${product.id},
                            title='Xem nhanh sản phẩm',
                            aria-label='Xem nhanh sản phẩm'">
                        <i class="fas fa-eye"></i>
                        <span class="sr-only">Xem nhanh sản phẩm</span>
                      </button>
                    </div>
                  </div>

                  <div class="product-body">
                    <a th:href="@{/chitietsanpham(id=${product.id})}">
                      <h3 th:text="${product.tenSanPham}" class="product-title"></h3>
                      <div class="price font-bold mt-2">
                        <span
                          th:text="${#numbers.formatDecimal(product.oldPrice, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">2.000.000
                          VNĐ</span>
                      </div>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>







  <!-- Modern Footer Design -->
  <footer class="bg-black text-white mt-12 relative z-10">
    <!-- Footer Wave Top -->
    <div class="absolute top-0 left-0 w-full overflow-hidden footer-wave">
      <svg class="relative block w-full rotate-180" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 1200 120" preserveAspectRatio="none">
        <path
          d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z"
          class="fill-white"></path>
      </svg>
    </div>

    <!-- Main Footer Content -->
    <div class="container mx-auto px-6 pt-20 pb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
        <!-- Column 1: About -->
        <div>
          <h3 class="text-xl font-bold mb-4">
            Poly Shoe Store
          </h3>
          <p class="text-gray-300 mb-4">Cửa hàng giày dép hàng đầu với các sản phẩm chất lượng và giá cả hợp lý.</p>
          <div class="flex space-x-4 mt-6">
            <a href="#"
              class="bg-white bg-opacity-20 hover:bg-red-600 hover:bg-opacity-100 p-2 rounded-full transition duration-300"
              aria-label="Facebook">
              Facebook
            </a>
            <a href="#"
              class="bg-white bg-opacity-20 hover:bg-red-600 hover:bg-opacity-100 p-2 rounded-full transition duration-300"
              aria-label="Instagram">
              Instagram
            </a>
            <a href="#"
              class="bg-white bg-opacity-20 hover:bg-red-600 hover:bg-opacity-100 p-2 rounded-full transition duration-300"
              aria-label="Twitter">
              Twitter
            </a>
          </div>
        </div>

        <!-- Column 2: Quick Links -->
        <div>
          <h3 class="text-xl font-bold mb-4">
            Liên kết nhanh
          </h3>
          <ul class="space-y-2">
            <li>
              <a href="/new" class="text-gray-300 hover:text-red-500">
                Sản phẩm mới
              </a>
            </li>
            <li>
              <a href="/all" class="text-gray-300 hover:text-red-500">
                Tất cả sản phẩm
              </a>
            </li>
            <li>
              <a href="/bestsellers" class="text-gray-300 hover:text-red-500">
                Sản phẩm bán chạy
              </a>
            </li>
            <li>
              <a href="/chinh-sach" class="text-gray-300 hover:text-red-500">
                Chính sách
              </a>
            </li>
          </ul>
        </div>

        <!-- Column 3: Contact -->
        <div>
          <h3 class="text-xl font-bold mb-4">
            Liên hệ
          </h3>
          <ul class="space-y-3">
            <li class="text-gray-300">
              FPT Polytechnic, Hà Nội
            </li>
            <li class="text-gray-300">
              +84 123 456 789
            </li>
            <li class="text-gray-300">
              polyshoe@example.com
            </li>
          </ul>
        </div>
      </div>

      <!-- Copyright -->
      <div class="border-t border-gray-800 mt-10 pt-6 flex flex-col md:flex-row justify-between items-center">
        <p class="text-sm text-gray-400">© 2025 Poly Shoe Store. All rights reserved.</p>
        <div class="mt-4 md:mt-0">
          <ul class="flex space-x-6">
            <li><a href="#" class="text-sm text-gray-400 hover:text-red-500">Điều khoản</a></li>
            <li><a href="#" class="text-sm text-gray-400 hover:text-red-500">Riêng tư</a></li>
            <li><a href="#" class="text-sm text-gray-400 hover:text-red-500">Cookies</a></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Subtle pattern overlay -->
    <div
      class="absolute top-0 left-0 w-full h-full bg-[linear-gradient(45deg,transparent_40%,rgba(255,255,255,0.02)_50%,transparent_60%),linear-gradient(-45deg,transparent_40%,rgba(255,255,255,0.02)_50%,transparent_60%)] bg-[length:60px_60px] animate-[patternMove_20s_linear_infinite] -z-10">
    </div>
  </footer>

  <button id="back-to-top" class="fixed bottom-20 right-20 bg-red-600 text-white p-3 rounded-full shadow-lg hidden"
    aria-label="Quay lại đầu trang">
    Lên
  </button>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
  <script src="/js/navbar.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      new Swiper('.banner-slider', {
        loop: true,
        autoplay: {
          delay: 6000,
          disableOnInteraction: false
        },
        navigation: {
          nextEl: '.swiper-button-next',
          prevEl: '.swiper-button-prev'
        },
        pagination: {
          el: '.swiper-pagination',
          clickable: true
        },
        effect: 'fade',
        fadeEffect: {
          crossFade: true
        },
        speed: 1000,
        on: {
          slideChangeTransitionStart: function () {
            // Reset animations
            const currentSlide = this.slides[this.activeIndex];
            const animations = currentSlide.querySelectorAll('.animate__animated');
            animations.forEach(el => {
              const animClass = el.className.match(/animate__[a-zA-Z]+(?!animated)/g);
              if (animClass) {
                el.classList.remove(...animClass);
                void el.offsetWidth; // Trigger reflow
                el.classList.add(...animClass);
              }
            });
          }
        }
      });
    });

    /* Hàm kiểm tra mã màu CSS */
    function isCssColor(value) {
      if (!value) return false;
      const s = new Option().style;
      s.color = value;
      return s.color !== '';
    }

    /* Hiển thị thông báo */
    function showSuccess(message) {
      Swal.fire({
        icon: 'success',
        title: 'Thành công',
        text: message,
        timer: 2000,
        showConfirmButton: false
      });
    }

    function showError(message) {
      Swal.fire({
        icon: 'error',
        title: 'Lỗi',
        text: message
      });
    }

    /* Cập nhật số lượng giỏ hàng */
    async function updateCartCount() {
      try {
        const response = await fetch('/api/cart/count', { credentials: 'include' });
        if (response.ok) {
          const data = await response.json();
          const countElement = document.getElementById('cart-count');
          if (countElement) countElement.textContent = data.count || '0';
        }
      } catch (error) {
        console.error('Lỗi khi cập nhật giỏ hàng:', error);
      }
    }

    /* -------- Cart + Quick view (biến thể) ------- */
    document.querySelectorAll('.cart-icon').forEach(button => {
      button.addEventListener('click', async () => {
        const modalEl = document.getElementById('addToCartModal');
        const modal = new bootstrap.Modal(modalEl);

        modalEl.querySelector('#modalProductImage').src = button.dataset.productImg || '';
        modalEl.querySelector('#modalProductName').textContent = button.dataset.productName || 'Sản phẩm';
        modalEl.querySelector('#modalProductStock').textContent = `Tồn kho: ${button.dataset.stock || 'N/A'}`;

        const productId = button.dataset.productId;

        let sizes = safeJSONParse(button.dataset.kichCo);
        let colors = safeJSONParse(button.dataset.mauSac);
        if (!Array.isArray(sizes) || !Array.isArray(colors) || (!sizes.length && !colors.length)) {
          try {
            const resp = await fetch(`/api/product/${encodeURIComponent(productId)}/options`, { headers: { Accept: 'application/json' } });
            if (resp.ok) {
              const j = await resp.json();
              sizes = j.sizes || [];
              colors = j.colors || [];
            }
          } catch (_) { }
        }

        const sizeWrap = modalEl.querySelector('#modalSizeOptions');
        const colorWrap = modalEl.querySelector('#modalColorOptions');
        sizeWrap.innerHTML = '';
        colorWrap.innerHTML = '';
        sizes.forEach(s => {
          const b = document.createElement('button');
          b.className = 'size-option';
          b.textContent = s.ten || s.name || 'Size';
          b.dataset.sizeId = s.id;
          sizeWrap.appendChild(b);
        });
        colors.forEach(c => {
          const b = document.createElement('button');
          b.className = 'color-option';
          const hex = (c.maMauHex || '').trim();
          if (hex && isCssColor(hex)) {
            b.dataset.swatch = 'true';
            b.style.backgroundColor = hex;
            b.title = c.tenMau || '';
          } else {
            b.textContent = c.tenMau || 'Màu';
          }
          b.dataset.colorId = c.id;
          colorWrap.appendChild(b);
        });

        const minusBtn = modalEl.querySelector('.quantity-btn.minus');
        const plusBtn = modalEl.querySelector('.quantity-btn.plus');
        const qtyInput = modalEl.querySelector('.quantity-input');
        minusBtn.onclick = () => {
          qtyInput.value = Math.max(1, (parseInt(qtyInput.value) || 1) - 1);
        };
        plusBtn.onclick = () => {
          const max = parseInt(qtyInput.max || '999999', 10);
          qtyInput.value = Math.min((parseInt(qtyInput.value) || 1) + 1, max);
        };

        let selectedSizeId = null, selectedColorId = null, currentVariant = null;
        const variantCache = new Map();
        let validCombos = null;

        async function tryLoadValidCombos() {
          const urls = [
            `/api/product/${encodeURIComponent(productId)}/valid-combinations`,
            `/api/product/${encodeURIComponent(productId)}/combinations`,
            `/api/product/${encodeURIComponent(productId)}/variants`
          ];
          for (const u of urls) {
            try {
              const r = await fetch(u, { headers: { Accept: 'application/json' } });
              if (r.ok) {
                const j = await r.json();
                if (Array.isArray(j)) {
                  validCombos = j;
                  return;
                }
              }
            } catch (_) { }
          }
          validCombos = null;
        }
        await tryLoadValidCombos();

        const keyOf = (sid, cid) => `${sid}-${cid}`;
        async function probeVariant(sid, cid) {
          const k = keyOf(sid, cid);
          if (variantCache.has(k)) return variantCache.get(k);
          const urls = [
            `/api/getChiTietSanPham?sanPhamId=${encodeURIComponent(productId)}&sizeId=${encodeURIComponent(sid)}&colorId=${encodeURIComponent(cid)}`,
            `/polyshoe/chi-tiet-san-pham/api?sanPhamId=${encodeURIComponent(productId)}&sizeId=${encodeURIComponent(sid)}&colorId=${encodeURIComponent(cid)}`
          ];
          let value = { exists: false };
          for (const u of urls) {
            try {
              const res = await fetch(u, { credentials: 'include' });
              if (!res.ok) continue;
              const data = await res.json();
              if (data?.id) {
                value = { exists: true, id: data.id, stock: data.soLuongTonKho, gia: data.gia, oldPrice: data.oldPrice };
                break;
              }
            } catch (_) { }
          }
          variantCache.set(k, value);
          return value;
        }

        function setDisabled(btn, dis) {
          btn.disabled = dis;
          btn.classList.toggle('opacity-50', dis);
          btn.classList.toggle('cursor-not-allowed', dis);
          if (dis) btn.classList.remove('active');
        }
        function enableAllSizes() {
          sizeWrap.querySelectorAll('.size-option').forEach(b => setDisabled(b, false));
        }
        function enableAllColors() {
          colorWrap.querySelectorAll('.color-option').forEach(b => setDisabled(b, false));
        }

        function applyEnableBySize(sid) {
          if (!sid) {
            enableAllColors();
            return;
          }
          const cBtns = [...colorWrap.querySelectorAll('.color-option')];
          if (validCombos) {
            const ok = new Set(validCombos.filter(v => String(v.sizeId) === String(sid)).map(v => String(v.colorId)));
            cBtns.forEach(b => setDisabled(b, !ok.has(b.dataset.colorId)));
          } else {
            Promise.all(cBtns.map(async b => {
              const r = await probeVariant(sid, b.dataset.colorId);
              setDisabled(b, !r.exists);
            }));
          }
        }
        function applyEnableByColor(cid) {
          if (!cid) {
            enableAllSizes();
            return;
          }
          const sBtns = [...sizeWrap.querySelectorAll('.size-option')];
          if (validCombos) {
            const ok = new Set(validCombos.filter(v => String(v.colorId) === String(cid)).map(v => String(v.sizeId)));
            sBtns.forEach(b => setDisabled(b, !ok.has(b.dataset.sizeId)));
          } else {
            Promise.all(sBtns.map(async b => {
              const r = await probeVariant(b.dataset.sizeId, cid);
              setDisabled(b, !r.exists);
            }));
          }
        }

        const stockEl = modalEl.querySelector('#modalProductStock');
        const priceEl = modalEl.querySelector('#modalProductPrice');

        async function fetchVariantAndRender() {
          if (!selectedSizeId || !selectedColorId) {
            currentVariant = null;
            stockEl.textContent = 'Tồn kho: hãy chọn size & màu';
            return;
          }
          let data = variantCache.get(keyOf(selectedSizeId, selectedColorId));
          if (!data || data.id == null) data = await probeVariant(selectedSizeId, selectedColorId);
          if (!data?.id) {
            currentVariant = null;
            stockEl.textContent = 'Biến thể không khả dụng';
            return;
          }
          currentVariant = { id: data.id, soLuongTonKho: data.stock, gia: data.gia, oldPrice: data.oldPrice };

          if (typeof data.stock === 'number') {
            stockEl.textContent = `Tồn kho: ${data.stock}`;
            qtyInput.max = data.stock;
            if (+qtyInput.value > data.stock) qtyInput.value = data.stock;
          } else {
            stockEl.textContent = 'Tồn kho: N/A';
            qtyInput.removeAttribute('max');
          }
          const cur = Number(data.gia || 0).toLocaleString('vi-VN') + ' VNĐ';
          if (data.oldPrice && data.oldPrice !== data.gia) {
            const old = Number(data.oldPrice).toLocaleString('vi-VN') + ' VNĐ';
            priceEl.innerHTML = `<span class="text-blue-800 font-bold mt-2">${old}</span>`;
          } else {
            priceEl.textContent = cur;
          }
        }

        sizeWrap.querySelectorAll('.size-option').forEach(b => {
          b.addEventListener('click', async () => {
            const was = b.classList.contains('active');
            if (was) {
              b.classList.remove('active');
              selectedSizeId = null;
              applyEnableBySize(null);
              if (selectedColorId) applyEnableByColor(selectedColorId);
              currentVariant = null;
              stockEl.textContent = selectedColorId ? 'Tồn kho: hãy chọn size' : `Tồn kho: ${button.dataset.stock || 'N/A'}`;
              qtyInput.removeAttribute('max');
              return;
            }
            sizeWrap.querySelectorAll('.size-option').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            selectedSizeId = b.dataset.sizeId;
            applyEnableBySize(selectedSizeId);
            await fetchVariantAndRender();
          });
        });

        colorWrap.querySelectorAll('.color-option').forEach(b => {
          b.addEventListener('click', async () => {
            const was = b.classList.contains('active');
            if (was) {
              b.classList.remove('active');
              selectedColorId = null;
              applyEnableByColor(null);
              if (selectedSizeId) applyEnableBySize(selectedSizeId);
              currentVariant = null;
              stockEl.textContent = selectedSizeId ? 'Tồn kho: hãy chọn màu' : `Tồn kho: ${button.dataset.stock || 'N/A'}`;
              qtyInput.removeAttribute('max');
              return;
            }
            colorWrap.querySelectorAll('.color-option').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            selectedColorId = b.dataset.colorId;
            applyEnableByColor(selectedColorId);
            await fetchVariantAndRender();
          });
        });

        modal.show();

        const confirmBtn = modalEl.querySelector('#confirmAddToCart');
        const errEl = modalEl.querySelector('#modalError');
        confirmBtn.onclick = async () => {
          errEl.classList.add('hidden');
          const sBtn = sizeWrap.querySelector('.size-option.active');
          const cBtn = colorWrap.querySelector('.color-option.active');
          if (!sBtn || !cBtn) {
            errEl.classList.remove('hidden');
            return;
          }
          if (!currentVariant?.id) {
            await fetchVariantAndRender();
            if (!currentVariant?.id) {
              showError('Không thể lấy thông tin biến thể!');
              return;
            }
          }
          const quantity = Math.max(1, parseInt(qtyInput.value) || 1);
          if (typeof currentVariant.soLuongTonKho === 'number' && quantity > currentVariant.soLuongTonKho) {
            showError('Số lượng vượt quá tồn kho!');
            return;
          }

          confirmBtn.disabled = true;
          confirmBtn.classList.add('loading');
          try {
            try {
              const authRes = await fetch('/api/cart/check-auth', { credentials: 'include' });
              if (authRes.ok) {
                const auth = await authRes.json();
                if (auth && auth.isAuthenticated === false) {
                  window.location.href = '/customers/login';
                  return;
                }
              }
            } catch (_) { }
            const payload = { id: currentVariant.id, quantity };
            const addRes = await fetch('/api/cart/add', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload)
            });
            if (addRes.ok) {
              showSuccess('Đã thêm vào giỏ hàng!');
              try {
                window.updateCartCount?.();
              } catch (_) { }
              modal.hide();
            } else {
              let msg = '';
              try {
                const j = await addRes.json();
                msg = j.error || JSON.stringify(j);
              } catch (_) {
                msg = await addRes.text();
              }
              showError(msg || 'Có lỗi xảy ra khi thêm vào giỏ hàng!');
            }
          } catch (e) {
            showError(e?.message || 'Lỗi mạng khi thêm vào giỏ hàng!');
          } finally {
            confirmBtn.disabled = false;
            confirmBtn.classList.remove('loading');
          }
        };
      });
    });

    /* ----------------- Quick View ----------------- */
    document.querySelectorAll('.quick-view-btn').forEach(button => {
      button.addEventListener('click', async () => {
        const productId = button.dataset.productId;
        let product = null;
        try {
          const res = await fetch(`/api/product/${encodeURIComponent(productId)}`, { headers: { Accept: 'application/json' } });
          if (!res.ok) throw new Error('Fetch failed');
          const ct = res.headers.get('content-type') || '';
          product = ct.includes('application/json') ? await res.json() : JSON.parse(await res.text());
        } catch (_) {
          alert('Không lấy được dữ liệu sản phẩm.');
          return;
        }

        const modalEl = document.createElement('div');
        modalEl.className = 'modal fade';
        modalEl.tabIndex = -1;
        modalEl.innerHTML = `
                <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
                    <div class="modal-header" style="background:#153054;color:#fff">
                        <h5 class="modal-title">${product.tenSanPham ?? 'Sản phẩm'}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <img src="${product.urlHinhAnh ?? ''}" alt="${product.tenSanPham ?? ''}" class="w-100 h-64 object-cover rounded mb-4">
                        <p class="text-blue-800 font-bold">${Number(product.price || 0).toLocaleString('vi-VN')} VNĐ</p>
                        <p class="text-sm text-gray-600">Tồn kho: ${product.tongSoLuong ?? 'N/A'}</p>
                        <p class="text-sm">${product.moTa || 'Không có mô tả'}</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <a href="/chitietsanpham?id=${product.id}" class="btn text-white" style="background:#153054;">Xem chi tiết</a>
                    </div>
                </div></div>`;
        document.body.appendChild(modalEl);
        const quickModal = new bootstrap.Modal(modalEl);
        quickModal.show();
        modalEl.addEventListener('hidden.bs.modal', () => modalEl.remove(), { once: true });
      });
    });
  </script>
  <!--chatbot-->
  <script>
    const qrTrigger = document.getElementById('qr-trigger');
    const qrMenu = document.getElementById('qr-menu');

    qrTrigger?.addEventListener('click', (e) => {
      e.stopPropagation();
      const open = qrMenu.classList.toggle('show');
      qrTrigger.setAttribute('aria-expanded', open ? 'true' : 'false');
      qrMenu.setAttribute('aria-hidden', open ? 'false' : 'true');
    });


    document.addEventListener('click', (e) => {
      if (!qrMenu) return;
      if (!qrMenu.contains(e.target) && !qrTrigger.contains(e.target)) {
        qrMenu.classList.remove('show');
        qrTrigger.setAttribute('aria-expanded', 'false');
        qrMenu.setAttribute('aria-hidden', 'true');
      }
    });


    function showQuickRow() {
      const el = document.getElementById('quick-row');
      if (el) el.style.display = 'flex';
    }
    function hideQuickRow() {
      const el = document.getElementById('quick-row');
      if (el) el.style.display = 'none';
    }


    qrMenu?.addEventListener('click', (e) => {
      const item = e.target.closest('.quick-reply');
      if (!item) return;

      qrMenu.classList.remove('show');
      qrTrigger.setAttribute('aria-expanded', 'false');
      qrMenu.setAttribute('aria-hidden', 'true');
    });








    quickCombo?.addEventListener('change', () => {
      const v = quickCombo.value.trim();
      if (!v) return;
      chatInput.value = v;
      chatInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
      quickCombo.selectedIndex = 0;
    });


    sendBtn?.addEventListener('click', () => {
      chatInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
    });


    function ensureGreeting() {
      const items = JSON.parse(sessionStorage.getItem('chat_history') || '[]');
      if (items.length > 0) return;

      const greet1 = 'Xin chào Bạn! Mình là trợ lý AI của PolyShoes';
      const greet2 = 'Mình rất sẵn lòng hỗ trợ Bạn 😊';

      const g1 = document.createElement('div');
      g1.className = 'chatbot-msg-bot';
      g1.textContent = greet1;

      const g2 = document.createElement('div');
      g2.className = 'chatbot-msg-bot';
      g2.textContent = greet2;

      chatMessages.appendChild(g1);
      chatMessages.appendChild(g2);

      saveToHistory('bot', greet1);
      saveToHistory('bot', greet2);

      chatMessages.scrollTop = chatMessages.scrollHeight;
      showQuickRow();
    }

    // Price formatting is now handled by Thymeleaf on the server side
    document.querySelectorAll('.formatted-old-price').forEach(el => {
      const raw = el.textContent.trim();
      const n = Number(String(raw).replace(/[^\d.-]/g, ''));
      if (Number.isFinite(n) && n > 0) el.textContent = n.toLocaleString('vi-VN') + ' VNĐ';
    });


  </script>
  <!--scroll-->
  <script>
    (function () {
      const ICONS = [
        { k: /\bquan|quần\b/i, icon: 'fa-person-walking' },
        { k: /\bgiay|giày\b/i, icon: 'fa-shoe-prints' },
        { k: /\bphu kien|phụ kiện\b/i, icon: 'fa-ring' },
        { k: /\bdam|đầm|vay|váy\b/i, icon: 'fa-person-dress' },
        { k: /\btre em|trẻ em|kid\b/i, icon: 'fa-child' },
        { k: /\bouter|khoac|khoác\b/i, icon: 'fa-jacket' },
      ];
      document.querySelectorAll('.cat-chip').forEach(chip => {
        const name = (chip.dataset.name || '').toLowerCase();
        const i = chip.querySelector('i'); if (!i) return;
        let found = 'fa-tags';
        for (const m of ICONS) { if (m.k.test(name)) { found = m.icon; break; } }
        i.className = 'fa-solid ' + found;
      });
    })();
    (function () {
      const OFFSET = 130;
      const ul = document.querySelector('#mini-tabs ul');
      const tabs = Array.from(document.querySelectorAll('#mini-tabs .tab-link'));
      const indicator = document.getElementById('tab-indicator');
      const sections = ['#section-new', '#section-all', '#section-best']
        .map(id => document.querySelector(id)).filter(Boolean);

      let isProgrammatic = false;
      let io = null;

      function moveIndicatorTo(el) {
        if (!el || !indicator || !ul) return;
        const left = el.offsetLeft - ul.scrollLeft;
        indicator.style.left = left + 'px';
        indicator.style.width = el.offsetWidth + 'px';
      }
      function setActiveTab(activeEl) {
        tabs.forEach(t => t.classList.remove('is-active'));
        activeEl?.classList.add('is-active');
        moveIndicatorTo(activeEl);
      }


      tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          const href = tab.getAttribute('href');
          if (!href || !href.startsWith('#')) return;
          e.preventDefault();

          const target = document.querySelector(href);
          if (!target) return;

          isProgrammatic = true;
          setActiveTab(tab);

          const y = target.getBoundingClientRect().top + window.pageYOffset - OFFSET;
          window.scrollTo({ top: y, behavior: 'smooth' });



          const unlock = () => { isProgrammatic = false; };
          if ('onscrollend' in window) {
            const once = () => { window.removeEventListener('scrollend', once); unlock(); };
            window.addEventListener('scrollend', once, { once: true });
          } else {

            const dist = Math.abs(window.scrollY - y);
            const dur = Math.min(800, Math.max(350, dist * 0.4));
            setTimeout(unlock, dur);
          }
        });
      });


      function attachObserver() {
        if (!('IntersectionObserver' in window)) return;
        io = new IntersectionObserver((entries) => {
          if (isProgrammatic) return;
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const id = '#' + entry.target.id;
              const current = tabs.find(t => t.getAttribute('href') === id);
              setActiveTab(current);
            }
          });
        }, {
          root: null,

          rootMargin: `-${OFFSET + 1}px 0px -55% 0px`,
          threshold: 0
        });
        sections.forEach(sec => io.observe(sec));
      }
      attachObserver();


      ul?.addEventListener('scroll', () => {
        const active = document.querySelector('#mini-tabs .tab-link.is-active') || tabs[0];
        moveIndicatorTo(active);
      }, { passive: true });
      window.addEventListener('resize', () => {
        const active = document.querySelector('#mini-tabs .tab-link.is-active') || tabs[0];
        moveIndicatorTo(active);
      });


      const defaultTab = document.querySelector('#mini-tabs .tab-link[href="#section-new"]') || tabs[0];
      setActiveTab(defaultTab);
    })();
  </script>
  <!--main-->
  <script>
    function safeJSONParse(val, fallback = []) {
      if (val == null || val === '' || val === 'undefined' || val === 'null') return fallback;


      try { return JSON.parse(val); } catch { }


      try {
        const t = document.createElement('textarea');
        t.innerHTML = val;
        const decoded = t.value;
        return JSON.parse(decoded);
      } catch {
        return fallback;
      }
    }
    function updateSendBtn() {
      const hasText = chatInput.value.trim().length > 0;
      sendBtn.style.backgroundColor = hasText ? '#1e4066' : '#9FD5F7';
      sendBtn.disabled = !hasText;
      sendBtn.style.opacity = hasText ? '1' : '.9';
      sendBtn.style.cursor = hasText ? 'pointer' : 'not-allowed';
    }


    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = chatInput.scrollHeight + 'px';
      updateSendBtn();
    });
    document.addEventListener('DOMContentLoaded', updateSendBtn);

    function openChat() {
      if (!chatBox.classList.contains('is-open')) {
        chatBox.classList.add('is-open');
        restoreHistory();
        ensureGreeting();
        requestAnimationFrame(() => chatInput?.focus());
      }
    }
    function closeChat() { chatBox.classList.remove('is-open'); }
    function isOpen() { return chatBox.classList.contains('is-open'); }

    toggleBtn.onclick = (e) => {
      e.stopPropagation();
      isOpen() ? closeChat() : openChat();
    };

    closeBtn.onclick = (e) => {
      e.stopPropagation();
      closeChat();
    };

    /* click ra ngoài để đóng */
    document.addEventListener('click', (e) => {
      if (!chatBox.contains(e.target) && !toggleBtn.contains(e.target)) closeChat();
    });


    /* nhấn ESC để đóng */
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen()) closeChat();
    });

    function saveToHistory(role, msg) {
      const current = JSON.parse(sessionStorage.getItem("chat_history") || "[]");
      current.push({ role, msg });
      sessionStorage.setItem("chat_history", JSON.stringify(current));
    }

    function restoreHistory() {
      const chatMessages = document.getElementById('chat-messages');
      chatMessages.innerHTML = '';
      const items = JSON.parse(sessionStorage.getItem("chat_history") || "[]");


      for (const item of items) {
        const div = document.createElement('div');
        div.className = item.role === 'user' ? 'chatbot-msg-user' : 'chatbot-msg-bot';
        div.innerHTML = item.msg;
        chatMessages.appendChild(div);
      }


      const hasUserMsg = items.some(i => i.role === 'user');
      if (hasUserMsg) hideQuickRow(); else showQuickRow();

      const typingIndicator = document.createElement('div');
      typingIndicator.id = 'typing-indicator';
      typingIndicator.className = 'chatbot-msg-bot hidden';
      typingIndicator.textContent = 'Đang soạn tin...';
      chatMessages.appendChild(typingIndicator);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }


    document.querySelectorAll('.quick-reply').forEach(btn => {
      btn.addEventListener('click', () => {
        chatInput.value = btn.textContent;
        chatInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
      });
    });

    chatInput.addEventListener('keydown', async (event) => {
      if (event.key !== 'Enter' || event.repeat) return;

      event.preventDefault();
      const message = chatInput.value.trim();
      if (!message) return;
      hideQuickRow();

      const userDiv = document.createElement('div');
      userDiv.className = 'chatbot-msg-user';
      userDiv.textContent = message;
      chatMessages.appendChild(userDiv);
      saveToHistory('user', message);
      chatInput.value = '';

      const typingIndicator = addTypingIndicator();
      chatMessages.scrollTop = chatMessages.scrollHeight;

      try {
        const response = await fetch('https://duclong206.app.n8n.cloud/webhook/website-chatbot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ body: { from: 'user_123', message } })
        });

        const data = await response.json();
        console.log('📥 Dữ liệu gốc từ bot:', data);

        const rawMessage = extractMessageFromResponse(data);
        const formattedMsg = formatMessage(rawMessage);

        const botDiv = document.createElement('div');
        botDiv.className = 'chatbot-msg-bot';
        botDiv.innerHTML = formattedMsg;
        chatMessages.appendChild(botDiv);
        saveToHistory('bot', botDiv.innerHTML);
        chatMessages.scrollTop = chatMessages.scrollHeight;

      } catch (error) {
        console.error('💥 Lỗi kết nối:', error);
        const botErr = document.createElement('div');
        botErr.className = 'chatbot-msg-bot';
        botErr.textContent = 'Lỗi kết nối. Vui lòng thử lại.';
        chatMessages.appendChild(botErr);
        saveToHistory('bot', botErr.textContent);
      } finally {
        typingIndicator.classList.add('hidden');
      }
    });

    function addTypingIndicator() {
      const existingIndicator = document.getElementById('typing-indicator');
      if (existingIndicator) existingIndicator.remove();

      const indicator = document.createElement('div');
      indicator.id = 'typing-indicator';
      indicator.className = 'chatbot-msg-bot';
      indicator.textContent = 'Đang soạn tin...';
      chatMessages.appendChild(indicator);
      return indicator;
    }

    function extractMessageFromResponse(data) {
      if (typeof data.message !== 'string') {
        if (typeof data.message === 'object' && data.message !== null && 'message' in data.message) {
          console.log('🔍 Dữ liệu từ object:', data.message.message);
          return data.message.message;
        }
        console.warn('🤷‍♂️ Không hiểu kiểu dữ liệu message:', data.message);
        return 'Xin lỗi, bot không phản hồi đúng định dạng.';
      }

      let cleanedMessage = data.message.replace(/```json\n|\n```/g, '').trim();
      console.log('Trước khi làm sạch:', cleanedMessage);

      cleanedMessage = cleanedMessage.replace(/[\u001F\u007F-\u009F]/g, '');
      console.log('Sau khi làm sạch:', cleanedMessage);

      try {
        const parsedData = JSON.parse(cleanedMessage);
        console.log('🧠 Dữ liệu sau parse:', parsedData.message);
        return parsedData.message || cleanedMessage;
      } catch (parseErr) {
        console.log('❌ Lỗi parse JSON:', parseErr);

        const messageMatch = cleanedMessage.match(/"message":\s*"([^"]*)"/);
        if (messageMatch && messageMatch[1]) {
          console.log('✅ Trích xuất thủ công thành công:', messageMatch[1]);
          return messageMatch[1];
        }
        console.log('⚠️ Không trích xuất được, sử dụng cleanedMessage:', cleanedMessage);
        return cleanedMessage;
      }
    }

    function isImageUrl(url) {

      return /\.(png|jpe?g|gif|webp|svg)(\?.*)?$/i.test(url);
    }

    function formatMessage(message) {

      if (/<\s*img\b[^>]*src=/i.test(message)) {
        return message;
      }


      return message
        .replace(
          /(https?:\/\/[^\s<]+|polyshoe\.site\/[^\s<]+)/g,
          (raw) => {
            const url = raw.startsWith('http') ? raw : 'https://' + raw;
            if (isImageUrl(url)) {
              return `<img src="${url}" alt="Ảnh" loading="lazy" style="max-width:100%;height:auto;margin-top:8px;" />`;
            }
            return `<a href="${url}" target="_blank" rel="noopener" style="color:#153054;text-decoration:underline;">${raw}</a>`;
          }
        )
        .replace(/\n/g, '<br>');
    };





    const backToTop = document.getElementById('back-to-top');
    window.addEventListener('scroll', () => {
      backToTop.classList.toggle('hidden', window.scrollY < 200);
    });
    backToTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

    document.addEventListener('DOMContentLoaded', updateCartCount);



  </script>
</body>

</html>