<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Poly Store Store - Chi ti·∫øt s·∫£n ph·∫©m</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="/css/black-white-red-theme.css" />
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/image/Poly Store.png" type="image/png" sizes="32x32" />
    <style>
        /* Messenger FAB (n√∫t m·ªü Messenger) */
        .messenger-fab {
            position: fixed;
            bottom: 92px;
            /* = 20px (chatbot) + 60px (n√∫t) + 12px kho·∫£ng c√°ch */
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #0084FF;
            /* m√†u Messenger */
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, .25);
            z-index: 10001;
            cursor: pointer;
            transition: transform .15s ease, box-shadow .15s ease;
        }

        .messenger-fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, .3);
        }

        .messenger-fab i {
            font-size: 28px;
        }

        @media (max-width: 640px) {
            .messenger-fab {
                bottom: 90px;
                right: 16px;
                width: 56px;
                height: 56px;
            }
        }

        /* Messenger FAB (n√∫t m·ªü Messenger) */
        .messenger-fab {
            position: fixed;
            bottom: 92px;
            /* = 20px (chatbot) + 60px (n√∫t) + 12px kho·∫£ng c√°ch */
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #0084FF;
            /* m√†u Messenger */
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, .25);
            z-index: 10001;
            cursor: pointer;
            transition: transform .15s ease, box-shadow .15s ease;
        }

        .messenger-fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, .3);
        }

        .messenger-fab i {
            font-size: 28px;
        }

        @media (max-width: 640px) {
            .messenger-fab {
                bottom: 90px;
                right: 16px;
                width: 56px;
                height: 56px;
            }
        }

        /* ƒêi·ªÅu ch·ªânh giao di·ªán cho ph·∫ßn th√¥ng tin ng·∫Øn g·ªçn */
        .rating-card dl {
            margin: 0;
            padding: 0;
        }

        .rating-card dl dt {
            min-width: 100px;
            /* ƒê·∫£m b·∫£o nh√£n c√≥ ƒë·ªô r·ªông c·ªë ƒë·ªãnh ƒë·ªÉ cƒÉn ch·ªânh */
            margin-right: 1rem;
        }

        .rating-card dl dd a {
            text-decoration: underline;
        }

        /* ƒêi·ªÅu ch·ªânh m√¥ t·∫£ chi ti·∫øt */
        #moTa {
            margin-bottom: 0.5rem;
        }

        /* T√πy ch·ªânh n√∫t "Xem th√™m" */
        #toggleBtn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            /* T∆∞∆°ng ƒë∆∞∆°ng text-sm */
        }

        /* Responsive */
        @media (max-width: 640px) {
            .rating-card dl dt {
                min-width: 80px;
            }

            #moTa {
                max-height: 3rem;
                /* ƒêi·ªÅu ch·ªânh chi·ªÅu cao tr√™n mobile */
            }
        }

        button[disabled] {
            pointer-events: none;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .navbar {
            background: linear-gradient(to right, #000000, #222222);
        }

        .navbar {
            position: fixed;
            top: 38px;
            left: 0;
            width: 100%;
            z-index: 1040;
        }

        .thumbnail-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            cursor: pointer;
        }

        .thumbnail-img:hover {
            opacity: 0.8;
        }

        .size-option.active,
        .color-option.active {
            background-color: #000000;
            color: white;
        }

        .ticker {
            background-color: #f8f8f8;
            color: #000000;
            font-weight: bold;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1050;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .dropdown:hover .dropdown-menu {
            display: block;
        }

        body {
            padding-top: 100px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-input {
            width: 60px;
            text-align: center;
        }

        .quantity-input:disabled {
            background-color: #f1f1f1;
            cursor: not-allowed;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .search-suggestions.active {
            opacity: 1;
            visibility: visible;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .suggestion-item:hover {
            background-color: #f1f5f9;
        }

        .suggestion-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 4px;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .history-item:hover {
            background-color: #e2e8f0;
        }

        .history-item .highlight {
            background-color: #9FD5F7;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .history-item .delete-btn {
            color: #ef4444;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }

        .history-item .delete-btn:hover {
            color: #b91c1c;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .search-suggestions.active {
            opacity: 1;
            visibility: visible;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .suggestion-item:hover {
            background-color: #f1f5f9;
        }

        .suggestion-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 4px;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .history-item:hover {
            background-color: #e2e8f0;
        }

        .history-item .highlight {
            background-color: #9FD5F7;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .history-item .delete-btn {
            color: #ef4444;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }

        .history-item .delete-btn:hover {
            color: #b91c1c;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .suggestion-item:hover {
            background-color: #f1f5f9;
        }

        .suggestion-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 4px;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .history-item:hover {
            background-color: #e2e8f0;
        }

        .history-item .highlight {
            background-color: #9FD5F7;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .history-item .delete-btn {
            color: #ef4444;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }

        .history-item .delete-btn:hover {
            color: #b91c1c;
        }

        @media (max-width: 640px) {
            .product-img {
                max-height: 300px;
            }

            .thumbnail-img {
                width: 60px;
                height: 60px;
            }

            .dropdown-menu {
                width: 100%;
                left: 0;
            }

            body {
                padding-top: 80px;
            }
        }

        .map-container {
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .map-container:hover {
            transform: translateY(-5px);
        }

        @keyframes patternMove {
            0% {
                background-position: 0 0, 0 0;
            }

            100% {
                background-position: 60px 60px, -60px 60px;
            }
        }

        @media (max-width: 768px) {
            .map-container iframe {
                height: 200px;
            }

            .container.mx-auto {
                padding: 0 10px;
            }
        }

        /*    chatbot*/
        #chatbot-box {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 420px;
            height: clamp(520px, 70vh, 640px);
            /* <-- th√™m */
            max-height: none;
            /* <-- b·ªè gi·ªõi h·∫°n c≈© */
            display: flex;
            flex-direction: column;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, .18);
            overflow: hidden;
            z-index: 10000;
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;

            /* tr·∫°ng th√°i ·∫©n */
            opacity: 0;
            transform: translateY(12px) scale(.98);
            pointer-events: none;
            visibility: hidden;
            transform-origin: bottom right;

            transition: opacity .25s ease, transform .25s ease, visibility .25s;
            will-change: opacity, transform;
        }

        #chat-messages {
            padding: 12px 12px 6px;
            flex: 1;
            /* <-- th√™m */
            min-height: 0;
            /* <-- r·∫•t quan tr·ªçng ƒë·ªÉ ph·∫ßn n√†y cu·ªôn ƒë∆∞·ª£c trong flex */
            overflow-y: auto;
            background: #fff;
        }


        /* tr·∫°ng th√°i hi·ªán */
        #chatbot-box.is-open {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
            visibility: visible;
        }

        /* t√¥n tr·ªçng gi·∫£m chuy·ªÉn ƒë·ªông */
        @media (prefers-reduced-motion: reduce) {
            #chatbot-box {
                transition: none;
            }
        }


        /* Header t·ªëi, icon tr√≤n */
        .cb-header {
            background: #000000;
            color: #fff;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-logo {
            width: 45px;
            height: 45px;
            border-radius: 30px;
            object-fit: cover;
        }

        .cb-header .brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
        }

        .cb-header .brand .dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #f8f8f8;
            display: inline-block;
        }

        /* QR combobox b√™n tr√°i input */
        .qr-wrap {
            position: relative;
        }

        .qr-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: #fff;
            color: #111827;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .qr-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .15);
        }

        .qr-menu {
            position: absolute;
            left: 0;
            bottom: 52px;
            /* n·ªïi ph√≠a tr√™n input */
            width: 260px;
            max-height: 260px;
            overflow: auto;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, .12);
            padding: 8px;
            display: none;
            z-index: 10001;
        }

        .qr-menu.show {
            display: block;
        }

        .qr-item {
            width: 100%;
            text-align: left;
            border: 0;
            background: #fff;
            color: #111827;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
        }

        .qr-item:hover {
            background: #f3f4f6;
        }

        .cb-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .cb-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, .08);
            color: #fff;
            cursor: pointer;
            border: 0;
        }

        .cb-icon:hover {
            background: rgba(255, 255, 255, .16);
        }

        /* V√πng tin nh·∫Øn */
        #chat-messages {
            padding: 12px 12px 6px;
            height: 420px;
            overflow-y: auto;
            background: #fff;
        }

        /* Bong b√≥ng bot + avatar b·∫±ng ::before */
        .chatbot-msg-bot {
            position: relative;
            background: #f3f4f6;
            color: #111827;
            padding: 10px 12px;
            border-radius: 14px 14px 14px 4px;
            max-width: 82%;
            margin: 0 56px 10px 40px;
            /* ch·ª´a ch·ªó avatar tr√°i */
            font-size: 15px;
            line-height: 1.45;
            word-wrap: break-word;
        }

        .chatbot-msg-bot::before {
            content: "";
            position: absolute;
            left: -40px;
            top: 4px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-image: url('/image/Poly Store.jpg');
            background-size: cover;
            background-position: center;
        }


        .chatbot-msg-user {
            background: #000000;
            color: #fff;
            padding: 10px 12px;
            border-radius: 14px 14px 4px 14px;
            max-width: 82%;
            margin: 0 0 10px auto;
            font-size: 15px;
            line-height: 1.45;
            word-wrap: break-word;
        }

        /* Typing indicator gi·∫£ l·∫≠p */
        #typing-indicator {
            opacity: .8;
            font-style: italic;
        }

        /* Quick reply d·∫°ng pill d∆∞·ªõi v√πng chat */
        .cb-quick {
            padding: 6px 12px 10px;
            background: #fff;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .cb-pill {
            border: 1px solid #e5e7eb;
            background: #fff;
            color: #111827;
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 14px;
            cursor: pointer;
            transition: .15s;
        }

        .cb-pill:hover {
            background: #f3f4f6;
        }

        /* Thanh nh·∫≠p + n√∫t g·ª≠i */
        .cb-inputbar {
            border-top: 1px solid #eee;
            padding: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
            background: #fff;
        }

        #chat-input {
            flex: 1;
            padding: 12px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            font-size: 15px;
            outline: none;
        }

        #chat-input:focus {
            border-color: #b6c2ff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .15);
        }

        #chat-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 0;
            background: #000000;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        /* Ghi ch√∫ nh·ªè gi·ªëng caption ‚ÄúTh√¥ng tin ch·ªâ mang t√≠nh tham kh·∫£o‚Ä¶‚Äù */
        .cb-note {
            padding: 6px 14px 12px;
            font-size: 10px;
            text-align: center;
            color: #6b7280;
            background: #fff;
        }

        #chat-input {
            flex: 1;
            resize: none;
            /* kh√¥ng cho k√©o th·ªß c√¥ng */
            overflow-y: hidden;
            /* ·∫©n thanh cu·ªôn */
            line-height: 1.4;
            max-height: 120px;
            /* gi·ªõi h·∫°n chi·ªÅu cao t·ªëi ƒëa (t·∫ßm 5-6 d√≤ng) */
        }

        @media (max-width: 640px) {
            #chatbot-box {
                width: 92vw;
                right: 4vw;
                bottom: 90px;
                /* tr√°nh ƒë√® n√∫t n·ªïi */
                height: 70vh;
            }
        }

        /* --- Reviews UI revamp --- */
        .rating-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
            padding: 16px
        }

        .star-big {
            font-size: 40px;
            line-height: 1
        }

        .star-row i {
            margin-right: 2px
        }

        .star-fill {
            color: #000000
        }

        /* black */
        .star-empty {
            color: #e5e7eb
        }

        .hist-row {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .hist-label {
            width: 24px;
            text-align: right;
            font-weight: 600;
            color: #6b7280
        }

        .hist-bar {
            flex: 1;
            height: 10px;
            background: #f3f4f6;
            border-radius: 999px;
            overflow: hidden
        }

        .hist-bar>span {
            display: block;
            height: 100%;
            background: #000000
        }

        .hist-count {
            width: 46px;
            text-align: left;
            color: #6b7280;
            font-size: 12px
        }

        .rating-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px
        }

        .filter-chip {
            border: 1px solid #e5e7eb;
            background: #fff;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer
        }

        .filter-chip.active {
            background: #000000;
            color: #fff;
            border-color: #000000
        }

        .sort-select {
            border: 1px solid #e5e7eb;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 14px;
            background: #fff
        }

        .review-card {
            border: 1px solid #f1f5f9;
            border-radius: 14px;
            padding: 14px
        }

        .review-card.my {
            border-color: #000000;
            box-shadow: 0 4px 14px rgba(0, 0, 0, .08)
        }

        .rev-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            color: #000000;
            font-weight: 700
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 6px;
            margin-top: 8px;
        }

        .media-grid img {
            width: 100%;
            max-width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            cursor: zoom-in;
            background: #f3f4f6;
        }

        .rev-meta {
            color: #9ca3af;
            font-size: 12px;
            margin-top: 6px
        }

        .skeleton {
            position: relative;
            overflow: hidden;
            background: #f3f4f6;
            border-radius: 12px;
            height: 88px
        }

        .skeleton::after {
            content: "";
            position: absolute;
            inset: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .6), transparent);
            animation: skeleton 1s infinite
        }

        @keyframes skeleton {
            to {
                transform: translateX(100%)
            }
        }

        /* Lightbox */
        .lb-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10550
        }

        .lb-backdrop.show {
            display: flex
        }

        .lb-backdrop img {
            max-width: min(92vw, 1024px);
            max-height: 86vh;
            border-radius: 10px
        }

        /* ===== ·∫¢NH S·∫¢N PH·∫®M ===== */
        .product-img {
            width: 100%;
            aspect-ratio: 4 / 3;
            /* gi·ªØ t·ªâ l·ªá khung, responsive */
            object-fit: contain;
            border: 1px solid #eef2f7;
            cursor: zoom-in;
            background: transparent;
        }

        /* Thumbnail: vu√¥ng, kh√¥ng m√©o, c√≥ focus ring */
        .thumbnail-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            /* ch·∫•p nh·∫≠n crop nh·∫π ƒë·ªÉ ƒë·ªìng ƒë·ªÅu √¥ vu√¥ng */
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            transition: transform .15s ease, box-shadow .15s ease;
        }

        .thumbnail-img:focus {
            outline: 2px solid #000000;
            outline-offset: 2px;
        }

        .thumbnail-img:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, .08);
        }

        /* Lightbox: gi·ªØ t·ªâ l·ªá t·ª± nhi√™n */
        .lb-backdrop img {
            max-width: min(92vw, 1024px);
            max-height: 86vh;
            width: auto;
            height: auto;
            transition: transform .2s ease;
        }

        /* Responsive tweak */
        @media (max-width: 640px) {
            .product-img {
                aspect-ratio: 1 / 1;
            }

            /* mobile: khung vu√¥ng cho g·ªçn */
            .thumbnail-img {
                width: 64px;
                height: 64px;
            }
        }

        .hist-bar {
            position: relative;
            overflow: hidden
        }

        .hist-bar>span {
            display: block;
            height: 100%;
            background: #000000;
            transform-origin: left;
            animation: grow .6s ease
        }

        @keyframes grow {
            from {
                transform: scaleX(.2)
            }

            to {
                transform: scaleX(1)
            }
        }
    </style>
</head>


<div th:replace="~{fragments/kh_navbar :: navbar(user=${user}, keyword=${keyword}, cartCount=${cartCount})}"></div>

<section class="container mx-auto py-8">
    <!-- ========== GRID: Tr√°i = ·∫¢nh, Ph·∫£i = Th√¥ng tin ========== -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- LEFT: IMAGES -->
        <div>
            <img th:src="${productDetail.urlHinhAnh}" th:alt="${productDetail.tenSanPham}"
                class="product-img rounded-lg" />
            <div class="flex space-x-2 mt-4">
                <img th:if="${productDetail.hinhAnhList != null and not #lists.isEmpty(productDetail.hinhAnhList)}"
                    th:each="image : ${productDetail.hinhAnhList}" th:src="${image}"
                    th:alt="${productDetail.tenSanPham}" class="thumbnail-img rounded" />
                <img th:unless="${productDetail.hinhAnhList != null and not #lists.isEmpty(productDetail.hinhAnhList)}"
                    th:src="${productDetail.urlHinhAnh}" th:alt="${productDetail.tenSanPham}"
                    class="thumbnail-img rounded" />
            </div>
        </div>

        <!-- RIGHT: NAME, CATEGORY, PRICE, SIZE, COLOR (+brand, stock, qty, buttons) -->
        <div>
            <!-- hidden for JS -->
            <input type="hidden" id="sanPhamId" th:value="${productDetail.sanPhamId}" />

            <h1 th:text="${productDetail.tenSanPham}" class="text-3xl font-bold text-gray-800 mb-2"></h1>

            <!-- Danh m·ª•c t·ª´ DTO: tenDanhMuc + danhMucId -->
            <p class="text-gray-600 mb-2" th:if="${productDetail.tenDanhMuc != null}">
                Lo·∫°i:
                <a class="text-[#153054] underline" th:href="@{'/category/' + ${productDetail.danhMucId}}"
                    th:text="${productDetail.tenDanhMuc}"></a>
            </p>

            <!-- Th∆∞∆°ng hi·ªáu (n·∫øu c√≥) -->
            <p class="text-gray-600 mb-2" th:if="${productDetail.thuongHieu != null}">
                Th∆∞∆°ng hi·ªáu: <span th:text="${productDetail.thuongHieu.tenThuongHieu}"></span>
            </p>

            <!-- Gi√° -->
            <div class="mb-4">
                <span id="detail-price" class="price text-black font-bold text-2xl"
                    th:attr="data-min=${minPrice},data-max=${maxPrice},data-old-min=${oldMinPrice},data-old-max=${oldMaxPrice}">
                </span>

                <div th:if="${productDetail.discountCampaignName != null}" class="text-sm text-green-600 mt-1">
                    <!--                    <span th:text="'Gi·∫£m gi√°: ' + ${productDetail.discountCampaignName}"></span>-->
                </div>
            </div>

            <!-- T·ªìn kho ƒë·ªông -->
            <p class="text-gray-600 mb-2">
                S·ªë l∆∞·ª£ng t·ªìn kho: <span id="dynamic-stock">Ch·ªçn m√†u & size</span>
            </p>

            <!-- Size -->
            <div class="size-selection mb-4">
                <h6 class="font-semibold">K√≠ch c·ª°:</h6>
                <div class="size-options flex flex-wrap gap-2 mt-2">
                    <button th:each="size : ${productDetail.kichCoList}" th:text="${size.ten}"
                        th:attr="data-size-id=${size.id}"
                        class="size-option px-4 py-2 border rounded hover:bg-[#e0ebf5] disabled:opacity-40">
                    </button>
                </div>
            </div>

            <!-- Color -->
            <div class="color-selection mb-4">
                <h6 class="font-semibold">M√†u s·∫Øc:</h6>
                <div class="color-options flex flex-wrap gap-2 mt-2">
                    <button th:each="color : ${productDetail.mauSacList}" th:text="${color.tenMau}"
                        th:attr="data-color-id=${color.id}"
                        class="color-option px-4 py-2 border rounded hover:bg-[#e0ebf5] disabled:opacity-40">
                    </button>
                </div>
            </div>

            <!-- Quantity -->
            <div class="quantity-selection mb-4">
                <h6 class="font-semibold">S·ªë l∆∞·ª£ng:</h6>
                <div class="quantity-control flex items-center space-x-2 mt-2">
                    <button class="quantity-btn minus px-3 py-1 bg-gray-200 rounded" disabled>-</button>
                    <input id="qty" type="number" value="1" min="1" th:max="${productDetail.soLuongTonKho}"
                        class="quantity-input border rounded w-20 text-center" disabled />
                    <button class="quantity-btn plus px-3 py-1 bg-gray-200 rounded" disabled>+</button>
                </div>
            </div>

            <!-- CTA -->
            <div class="button-group mt-4">
                <button id="btnAddToCart"
                    class="btn bg-black text-white hover:bg-gray-800 px-6 py-2 rounded add-to-cart" th:attr="data-product-id=${productDetail.id},
                         data-san-pham-id=${productDetail.sanPhamId},
                         data-product-name=${productDetail.tenSanPham},
                         data-product-price=${#numbers.formatDecimal(productDetail.gia, 0, 0, 'COMMA')},
                         data-raw-price=${productDetail.gia},
                         data-product-img=${productDetail.urlHinhAnh}">
                    <i class="fas fa-shopping-cart"></i> Th√™m v√†o gi·ªè h√†ng
                </button>
                <button id="btnBuyNow" class="btn bg-green-600 text-white hover:bg-green-700 px-6 py-2 rounded buy-now"
                    th:attr="data-product-id=${productDetail.id},
                         data-san-pham-id=${productDetail.sanPhamId},
                         data-product-name=${productDetail.tenSanPham},
                         data-product-price=${productDetail.gia},
                         data-raw-price=${productDetail.gia},
                         data-product-img=${productDetail.urlHinhAnh}">
                    <i class="fas fa-bolt"></i> Mua ngay
                </button>
                <a href="/" class="btn bg-gray-500 text-white hover:bg-gray-600 px-6 py-2 rounded">
                    <i class="fas fa-home"></i> Quay l·∫°i trang ch·ªß
                </a>
            </div>
        </div>
    </div>

    <!-- DESCRIPTION & PRODUCT INFO -->
    <div class="bg-white rating-card mt-10 p-6">
        <!-- Ti√™u ƒë·ªÅ chung -->
        <h2 class="text-2xl font-bold text-black mb-4">M√¥ t·∫£ s·∫£n ph·∫©m</h2>

        <!-- Th√¥ng tin ng·∫Øn g·ªçn (tr√™n c√πng) -->
        <div class="mb-6">
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2 text-sm">
                <!-- M√£ s·∫£n ph·∫©m -->
                <div th:if="${productDetail.maSanPham != null}" class="flex items-start">
                    <dt class="text-gray-500 font-medium mr-2">M√£ s·∫£n ph·∫©m:</dt>
                    <dd class="text-gray-900" th:text="${productDetail.maSanPham}"></dd>
                </div>

                <!-- Danh m·ª•c -->
                <div th:if="${productDetail.tenDanhMuc != null}" class="flex items-start">
                    <dt class="text-gray-500 font-medium mr-2">Lo·∫°i:</dt>
                    <dd class="text-gray-900">
                        <a class="text-black underline" th:href="@{'/category/' + ${productDetail.danhMucId}}"
                            th:text="${productDetail.tenDanhMuc}"></a>
                    </dd>
                </div>

                <!-- Th∆∞∆°ng hi·ªáu -->
                <div th:if="${productDetail.thuongHieu != null}" class="flex items-start">
                    <dt class="text-gray-500 font-medium mr-2">Th∆∞∆°ng hi·ªáu:</dt>
                    <dd class="text-gray-900" th:text="${productDetail.thuongHieu.tenThuongHieu}"></dd>
                </div>

                <!-- Ch·∫•t li·ªáu -->
                <div th:if="${productDetail.chatLieu != null}" class="flex items-start">
                    <dt class="text-gray-500 font-medium mr-2">Ch·∫•t li·ªáu:</dt>
                    <dd class="text-gray-900" th:text="${productDetail.chatLieu.tenChatLieu}"></dd>
                </div>

                <!-- Xu·∫•t x·ª© -->
                <div th:if="${productDetail.xuatXu != null}" class="flex items-start">
                    <dt class="text-gray-500 font-medium mr-2">Xu·∫•t x·ª©:</dt>
                    <dd class="text-gray-900" th:text="${productDetail.xuatXu.tenXuatXu}"></dd>
                </div>

                <!-- Ki·ªÉu d√°ng -->
                <div th:if="${productDetail.kieuDang != null}" class="flex items-start">
                    <dt class="text-gray-500 font-medium mr-2">Ki·ªÉu d√°ng:</dt>
                    <dd class="text-gray-900" th:text="${productDetail.kieuDang.tenKieuDang}"></dd>
                </div>



                <!-- Gi·ªõi t√≠nh -->
                <div th:if="${productDetail.gioiTinh != null}" class="flex items-start">
                    <dt class="text-gray-500 font-medium mr-2">Gi·ªõi t√≠nh:</dt>
                    <dd class="text-gray-900" th:text="${productDetail.gioiTinh}"></dd>
                </div>

                <!-- Khuy·∫øn m√£i -->
                <div th:if="${productDetail.discountCampaignName != null}" class="flex items-start">
                    <dt class="text-gray-500 font-medium mr-2">Khuy·∫øn m√£i:</dt>
                    <dd class="text-green-700" th:text="${productDetail.discountCampaignName}"></dd>
                </div>
            </dl>
        </div>

    </div>

    <!-- Lightbox -->
    <div id="lb" class="lb-backdrop hidden fixed inset-0 bg-black/70 z-40 items-center justify-center">
        <img class="max-h-[80vh] max-w-[90vw] rounded shadow-lg" alt="preview">
    </div>
</section>





<!-- Modern Footer Design -->
<footer class="bg-black text-white mt-12 relative z-10">
    <!-- Footer Wave Top -->
    <div class="absolute top-0 left-0 w-full overflow-hidden footer-wave">
        <svg class="relative block w-full rotate-180" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 1200 120" preserveAspectRatio="none">
            <path
                d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z"
                class="fill-white"></path>
        </svg>
    </div>

    <!-- Main Footer Content -->
    <div class="container mx-auto px-6 pt-20 pb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
            <!-- Column 1: About -->
            <div>
                <h3 class="text-xl font-bold mb-4">
                    Poly Shoe Store
                </h3>
                <p class="text-gray-300 mb-4">C·ª≠a h√†ng gi√†y d√©p h√†ng ƒë·∫ßu v·ªõi c√°c s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng v√† gi√° c·∫£ h·ª£p l√Ω.
                </p>
                <div class="flex space-x-4 mt-6">
                    <a href="#"
                        class="bg-white bg-opacity-20 hover:bg-red-600 hover:bg-opacity-100 p-2 rounded-full transition duration-300"
                        aria-label="Facebook">
                        Facebook
                    </a>
                    <a href="#"
                        class="bg-white bg-opacity-20 hover:bg-red-600 hover:bg-opacity-100 p-2 rounded-full transition duration-300"
                        aria-label="Instagram">
                        Instagram
                    </a>
                    <a href="#"
                        class="bg-white bg-opacity-20 hover:bg-red-600 hover:bg-opacity-100 p-2 rounded-full transition duration-300"
                        aria-label="Twitter">
                        Twitter
                    </a>
                </div>
            </div>

            <!-- Column 2: Quick Links -->
            <div>
                <h3 class="text-xl font-bold mb-4">
                    Li√™n k·∫øt nhanh
                </h3>
                <ul class="space-y-2">
                    <li>
                        <a href="/new" class="text-gray-300 hover:text-red-500">
                            S·∫£n ph·∫©m m·ªõi
                        </a>
                    </li>
                    <li>
                        <a href="/all" class="text-gray-300 hover:text-red-500">
                            T·∫•t c·∫£ s·∫£n ph·∫©m
                        </a>
                    </li>
                    <li>
                        <a href="/bestsellers" class="text-gray-300 hover:text-red-500">
                            S·∫£n ph·∫©m b√°n ch·∫°y
                        </a>
                    </li>
                    <li>
                        <a href="/chinh-sach" class="text-gray-300 hover:text-red-500">
                            Ch√≠nh s√°ch
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Column 3: Contact -->
            <div>
                <h3 class="text-xl font-bold mb-4">
                    Li√™n h·ªá
                </h3>
                <ul class="space-y-3">
                    <li class="text-gray-300">
                        FPT Polytechnic, H√† N·ªôi
                    </li>
                    <li class="text-gray-300">
                        +84 123 456 789
                    </li>
                    <li class="text-gray-300">
                        polyshoe@example.com
                    </li>
                </ul>
            </div>
        </div>

        <!-- Copyright -->
        <div class="border-t border-gray-800 mt-10 pt-6 flex flex-col md:flex-row justify-between items-center">
            <p class="text-sm text-gray-400">¬© 2025 Poly Shoe Store. All rights reserved.</p>
            <div class="mt-4 md:mt-0">
                <ul class="flex space-x-6">
                    <li><a href="#" class="text-sm text-gray-400 hover:text-red-500">ƒêi·ªÅu kho·∫£n</a></li>
                    <li><a href="#" class="text-sm text-gray-400 hover:text-red-500">Ri√™ng t∆∞</a></li>
                    <li><a href="#" class="text-sm text-gray-400 hover:text-red-500">Cookies</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Subtle pattern overlay -->
    <div
        class="absolute top-0 left-0 w-full h-full bg-[linear-gradient(45deg,transparent_40%,rgba(255,255,255,0.02)_50%,transparent_60%),linear-gradient(-45deg,transparent_40%,rgba(255,255,255,0.02)_50%,transparent_60%)] bg-[length:60px_60px] animate-[patternMove_20s_linear_infinite] -z-10">
    </div>
</footer>

<button id="back-to-top" class="fixed bottom-20 right-20 bg-red-600 text-white p-3 rounded-full shadow-lg hidden"
    aria-label="Quay l·∫°i ƒë·∫ßu trang">
    L√™n
</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/navbar.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    window.validCombinations = /*[[${productDetail.validCombinations}]]*/[];
    /*]]>*/
</script>

<!-- WebSocket libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<!--chatbot-->
<script>
    const qrTrigger = document.getElementById('qr-trigger');
    const qrMenu = document.getElementById('qr-menu');

    qrTrigger?.addEventListener('click', (e) => {
        e.stopPropagation();
        const open = qrMenu.classList.toggle('show');
        qrTrigger.setAttribute('aria-expanded', open ? 'true' : 'false');
        qrMenu.setAttribute('aria-hidden', open ? 'false' : 'true');
    });

    // click ngo√†i ƒë·ªÉ ƒë√≥ng menu
    document.addEventListener('click', (e) => {
        if (!qrMenu) return;
        if (!qrMenu.contains(e.target) && !qrTrigger.contains(e.target)) {
            qrMenu.classList.remove('show');
            qrTrigger.setAttribute('aria-expanded', 'false');
            qrMenu.setAttribute('aria-hidden', 'true');
        }
    });


    function showQuickRow() {
        const el = document.getElementById('quick-row');
        if (el) el.style.display = 'flex';
    }
    function hideQuickRow() {
        const el = document.getElementById('quick-row');
        if (el) el.style.display = 'none';
    }

    // ƒê√≥ng combobox khi ch·ªçn quick-reply trong menu
    qrMenu?.addEventListener('click', (e) => {
        const item = e.target.closest('.quick-reply');
        if (!item) return;
        // t·∫Øt menu ngay
        qrMenu.classList.remove('show');
        qrTrigger.setAttribute('aria-expanded', 'false');
        qrMenu.setAttribute('aria-hidden', 'true');
    });


    // ====== DOM refs m·ªõi ======


    // ====== Reload l·ªãch s·ª≠ ======
    reloadBtn?.addEventListener('click', () => {
        // Xo√° to√†n b·ªô l·ªãch s·ª≠ chat trong sessionStorage
        sessionStorage.removeItem('chat_history');

        // Xo√° tin nh·∫Øn tr√™n giao di·ªán
        chatMessages.innerHTML = '';
        showQuickRow();


        // G·ªçi l·ªùi ch√†o m·∫∑c ƒë·ªãnh nh∆∞ m·ªõi m·ªü
        ensureGreeting();
    });

    // ====== Quick-reply combobox ======
    quickCombo?.addEventListener('change', () => {
        const v = quickCombo.value.trim();
        if (!v) return;
        chatInput.value = v;
        chatInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
        quickCombo.selectedIndex = 0; // reset l·∫°i option ƒë·∫ßu
    });

    // ====== N√∫t g·ª≠i click = nh·∫•n Enter ======
    sendBtn?.addEventListener('click', () => {
        chatInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
    });

    // ====== Auto ch√†o khi m·ªü l·∫ßn ƒë·∫ßu ======
    function ensureGreeting() {
        const items = JSON.parse(sessionStorage.getItem('chat_history') || '[]');
        if (items.length > 0) return;

        const greet1 = 'Xin ch√†o B·∫°n! M√¨nh l√† tr·ª£ l√Ω AI c·ªßa Poly Store Store';
        const greet2 = 'M√¨nh r·∫•t s·∫µn l√≤ng h·ªó tr·ª£ B·∫°n üòä';

        const g1 = document.createElement('div');
        g1.className = 'chatbot-msg-bot';
        g1.textContent = greet1;

        const g2 = document.createElement('div');
        g2.className = 'chatbot-msg-bot';
        g2.textContent = greet2;

        chatMessages.appendChild(g1);
        chatMessages.appendChild(g2);

        saveToHistory('bot', greet1);
        saveToHistory('bot', greet2);

        chatMessages.scrollTop = chatMessages.scrollHeight;
        showQuickRow(); // hi·ªán quick-reply khi l·∫ßn ƒë·∫ßu m·ªü
    }

    function formatVND(n) {
        return new Intl.NumberFormat('vi-VN').format(n) + ' VNƒê';
    }
    function formatPrice() {
        // Format price
        document.querySelectorAll('.price').forEach(el => {
            const raw = el.dataset.price;
            if (!raw || isNaN(raw)) return;
            el.textContent = formatVND(raw);
        });

        // Format old price
        document.querySelectorAll('.old-price span').forEach(el => {
            const raw = el.dataset.oldPrice;
            if (!raw || isNaN(raw)) return;
            el.textContent = formatVND(raw);
        });
    }

    function showPriceRange() {
        const priceEl = document.getElementById('detail-price');
        const oldEl = document.getElementById('detail-old-price');
        if (!priceEl) return;

        const min = parseFloat(priceEl.dataset.min);
        const max = parseFloat(priceEl.dataset.max);
        const oldMin = parseFloat(priceEl.dataset.oldMin);
        const oldMax = parseFloat(priceEl.dataset.oldMax);

        if (min && max) {
            if (min === max) {
                // N·∫øu min v√† max b·∫±ng nhau, ch·ªâ hi·ªÉn th·ªã m·ªôt gi√°
                priceEl.textContent = formatVND(min);
            } else {
                // N·∫øu kh√°c nhau, hi·ªÉn th·ªã kho·∫£ng gi√°
                priceEl.textContent = `${formatVND(min)} - ${formatVND(max)}`;
            }
        }

        if (oldEl && oldMin && oldMax && (oldMin !== min || oldMax !== max)) {
            if (oldMin === oldMax) {
                // N·∫øu gi√° g·ªëc min v√† max b·∫±ng nhau, ch·ªâ hi·ªÉn th·ªã m·ªôt gi√° g·ªëc
                oldEl.textContent = formatVND(oldMin);
                oldEl.style.display = 'inline-block';
            } else {
                // N·∫øu gi√° g·ªëc min v√† max kh√°c nhau, hi·ªÉn th·ªã kho·∫£ng gi√° g·ªëc
                oldEl.textContent = `${formatVND(oldMin)} - ${formatVND(oldMax)}`;
                oldEl.style.display = 'inline-block';
            }
        } else if (oldEl) {
            oldEl.style.display = 'none';
        }
    }
    // Format the old price in the same way as the regular price
    document.querySelectorAll('.formatted-old-price').forEach(el => {
        const raw = el.textContent.trim();
        if (!raw || isNaN(raw)) {
            return;
        }
        const formatted = Number(raw).toLocaleString('vi-VN') + ' VNƒê';
        el.textContent = formatted;
    });

    function updateSendBtn() {
        const hasText = chatInput.value.trim().length > 0;
        sendBtn.style.backgroundColor = hasText ? '#000000' : '#cccccc';
        sendBtn.disabled = !hasText;
        sendBtn.style.opacity = hasText ? '1' : '.9';
        sendBtn.style.cursor = hasText ? 'pointer' : 'not-allowed';
    }



    chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = chatInput.scrollHeight + 'px';
        updateSendBtn();
    });
    document.addEventListener('DOMContentLoaded', updateSendBtn);

    function openChat() {
        if (!chatBox.classList.contains('is-open')) {
            chatBox.classList.add('is-open');
            restoreHistory();
            ensureGreeting();
            requestAnimationFrame(() => chatInput?.focus());
        }
    }
    function closeChat() { chatBox.classList.remove('is-open'); }
    function isOpen() { return chatBox.classList.contains('is-open'); }

    toggleBtn.onclick = (e) => {
        e.stopPropagation();
        isOpen() ? closeChat() : openChat();
    };

    closeBtn.onclick = (e) => {
        e.stopPropagation();
        closeChat();
    };

    /* click ra ngo√†i ƒë·ªÉ ƒë√≥ng */
    document.addEventListener('click', (e) => {
        if (!chatBox.contains(e.target) && !toggleBtn.contains(e.target)) closeChat(); // ‚úÖ
    });


    /* nh·∫•n ESC ƒë·ªÉ ƒë√≥ng */
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isOpen()) closeChat();
    });

    function saveToHistory(role, msg) {
        const current = JSON.parse(sessionStorage.getItem("chat_history") || "[]");
        current.push({ role, msg });
        sessionStorage.setItem("chat_history", JSON.stringify(current));
    }

    function restoreHistory() {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = '';
        const items = JSON.parse(sessionStorage.getItem("chat_history") || "[]");

        // render l·∫°i l·ªãch s·ª≠
        for (const item of items) {
            const div = document.createElement('div');
            div.className = item.role === 'user' ? 'chatbot-msg-user' : 'chatbot-msg-bot';
            div.innerHTML = item.msg;
            chatMessages.appendChild(div);
        }

        // hi·ªán quick-reply n·∫øu CH∆ØA c√≥ tin nh·∫Øn user n√†o
        const hasUserMsg = items.some(i => i.role === 'user');
        if (hasUserMsg) hideQuickRow(); else showQuickRow();

        const typingIndicator = document.createElement('div');
        typingIndicator.id = 'typing-indicator';
        typingIndicator.className = 'chatbot-msg-bot hidden';
        typingIndicator.textContent = 'ƒêang so·∫°n tin...';
        chatMessages.appendChild(typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }


    document.querySelectorAll('.quick-reply').forEach(btn => {
        btn.addEventListener('click', () => {
            chatInput.value = btn.textContent;
            chatInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
        });
    });

    chatInput.addEventListener('keydown', async (event) => {
        if (event.key !== 'Enter' || event.repeat) return;

        event.preventDefault();
        const message = chatInput.value.trim();
        if (!message) return;
        hideQuickRow();

        const userDiv = document.createElement('div');
        userDiv.className = 'chatbot-msg-user';
        userDiv.textContent = message;
        chatMessages.appendChild(userDiv);
        saveToHistory('user', message);
        chatInput.value = '';

        const typingIndicator = addTypingIndicator();
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
            const response = await fetch('https://duclong206.app.n8n.cloud/webhook/website-chatbot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ body: { from: 'user_123', message } })
            });

            const data = await response.json();
            console.log('üì• D·ªØ li·ªáu g·ªëc t·ª´ bot:', data);

            const rawMessage = extractMessageFromResponse(data);
            const formattedMsg = formatMessage(rawMessage);

            const botDiv = document.createElement('div');
            botDiv.className = 'chatbot-msg-bot';
            botDiv.innerHTML = formattedMsg;
            chatMessages.appendChild(botDiv);
            saveToHistory('bot', botDiv.innerHTML);
            chatMessages.scrollTop = chatMessages.scrollHeight;

        } catch (error) {
            console.error('üí• L·ªói k·∫øt n·ªëi:', error);
            const botErr = document.createElement('div');
            botErr.className = 'chatbot-msg-bot';
            botErr.textContent = 'L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.';
            chatMessages.appendChild(botErr);
            saveToHistory('bot', botErr.textContent);
        } finally {
            typingIndicator.classList.add('hidden');
        }
    });

    function addTypingIndicator() {
        const existingIndicator = document.getElementById('typing-indicator');
        if (existingIndicator) existingIndicator.remove();

        const indicator = document.createElement('div');
        indicator.id = 'typing-indicator';
        indicator.className = 'chatbot-msg-bot';
        indicator.textContent = 'ƒêang so·∫°n tin...';
        chatMessages.appendChild(indicator);
        return indicator;
    }

    function extractMessageFromResponse(data) {
        if (typeof data.message !== 'string') {
            if (typeof data.message === 'object' && data.message !== null && 'message' in data.message) {
                console.log('üîç D·ªØ li·ªáu t·ª´ object:', data.message.message);
                return data.message.message;
            }
            console.warn('ü§∑‚Äç‚ôÇÔ∏è Kh√¥ng hi·ªÉu ki·ªÉu d·ªØ li·ªáu message:', data.message);
            return 'Xin l·ªói, bot kh√¥ng ph·∫£n h·ªìi ƒë√∫ng ƒë·ªãnh d·∫°ng.';
        }

        let cleanedMessage = data.message.replace(/\`\`\`json\n|\n\`\`\`/g, '').trim();
        console.log('Tr∆∞·ªõc khi l√†m s·∫°ch:', cleanedMessage);

        cleanedMessage = cleanedMessage.replace(/[\u001F\u007F-\u009F]/g, '');
        console.log('Sau khi l√†m s·∫°ch:', cleanedMessage);

        try {
            const parsedData = JSON.parse(cleanedMessage);
            console.log('üß† D·ªØ li·ªáu sau parse:', parsedData.message);
            return parsedData.message || cleanedMessage;
        } catch (parseErr) {
            console.log('‚ùå L·ªói parse JSON:', parseErr);
            // Tr√≠ch xu·∫•t th·ªß c√¥ng n·∫øu parse th·∫•t b·∫°i
            const messageMatch = cleanedMessage.match(/"message":\s*"([^"]*)"/);
            if (messageMatch && messageMatch[1]) {
                console.log('‚úÖ Tr√≠ch xu·∫•t th·ªß c√¥ng th√†nh c√¥ng:', messageMatch[1]);
                return messageMatch[1];
            }
            console.log('‚ö†Ô∏è Kh√¥ng tr√≠ch xu·∫•t ƒë∆∞·ª£c, s·ª≠ d·ª•ng cleanedMessage:', cleanedMessage);
            return cleanedMessage;
        }
    }

    function isImageUrl(url) {
        // Nh·∫≠n di·ªán link ·∫£nh ph·ªï bi·∫øn, cho ph√©p c√≥ query string
        return /\.(png|jpe?g|gif|webp|svg)(\?.*)?$/i.test(url);
    }

    function formatMessage(message) {
        // N·∫øu bot ƒë√£ g·ª≠i s·∫µn th·∫ª <img>, gi·ªØ nguy√™n (tr√°nh replace URL b√™n trong th·∫ª)
        if (/<\s*img\b[^>]*src=/i.test(message)) {
            return message; // ho·∫∑c: return message.replace(/\n/g, '<br>'); n·∫øu mu·ªën √©p xu·ªëng d√≤ng
        }

        // X·ª≠ l√Ω t·∫•t c·∫£ URLs: link ·∫£nh -> <img>, link kh√°c -> <a>
        return message
            .replace(
                /(https?:\/\/[^\s<]+|polyshoe\.site\/[^\s<]+)/g,
                (raw) => {
                    const url = raw.startsWith('http') ? raw : 'https://' + raw;
                    if (isImageUrl(url)) {
                        return `<img src="${url}" alt="·∫¢nh" loading="lazy" style="max-width:100%;height:auto;margin-top:8px;" />`;
                    }
                    return `<a href="${url}" target="_blank" rel="noopener" style="color:#000000;text-decoration:underline;">${raw}</a>`;
                }
            )
            .replace(/\n/g, '<br>');
    }

    // Apply formatPrice to both price and old price elements
    window.addEventListener('DOMContentLoaded', function () {
        showPriceRange();
        formatPrice();
    });

    //s·∫Øp x·∫øp size

    document.addEventListener('DOMContentLoaded', () => {
        const order = ["XS", "S", "M", "L", "XL", "XXL", "3XL", "4XL"]; // th·ª© t·ª± chu·∫©n
        const container = document.querySelector('.size-options');
        if (!container) return;

        // L·∫•y t·∫•t c·∫£ button size
        const buttons = Array.from(container.querySelectorAll('.size-option'));

        // S·∫Øp x·∫øp theo th·ª© t·ª± trong m·∫£ng order
        buttons.sort((a, b) => {
            const aIndex = order.indexOf(a.textContent.trim());
            const bIndex = order.indexOf(b.textContent.trim());
            return aIndex - bIndex;
        });

        // Clear container v√† append l·∫°i theo th·ª© t·ª±
        container.innerHTML = '';
        buttons.forEach(btn => container.appendChild(btn));
    });
</script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
        const sizeOptions = document.querySelectorAll('.size-option');
        const colorOptions = document.querySelectorAll('.color-option');
        const mainImage = document.querySelector('.product-img');
        const defaultImage = mainImage.src; // ·∫¢nh m·∫∑c ƒë·ªãnh khi ch∆∞a ch·ªçn size ho·∫∑c m√†u

        // Khi ch·ªçn size ho·∫∑c color, ki·ªÉm tra v√† c·∫≠p nh·∫≠t ·∫£nh
        sizeOptions.forEach(option => {
            option.addEventListener('click', () => {
                updateMainImage();
            });
        });

        colorOptions.forEach(option => {
            option.addEventListener('click', () => {
                updateMainImage();
            });
        });

        // H√†m ki·ªÉm tra v√† c·∫≠p nh·∫≠t ·∫£nh ch√≠nh
        function updateMainImage() {
            const selectedSize = document.querySelector('.size-option.active');
            const selectedColor = document.querySelector('.color-option.active');

            if (!selectedSize || !selectedColor) {
                // N·∫øu ch∆∞a ch·ªçn ƒë·∫ßy ƒë·ªß, tr·ªü v·ªÅ ·∫£nh m·∫∑c ƒë·ªãnh
                mainImage.src = defaultImage;
            } else {
                // N·∫øu ƒë√£ ch·ªçn ƒë·∫ßy ƒë·ªß, c·∫≠p nh·∫≠t ·∫£nh s·∫£n ph·∫©m t∆∞∆°ng ·ª©ng
                const sizeId = selectedSize.dataset.sizeId;
                const colorId = selectedColor.dataset.colorId;
                fetch(`/api/getChiTietSanPham?sanPhamId=${sanPhamId}&sizeId=${sizeId}&colorId=${colorId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.images && data.images.length > 0) {
                            mainImage.src = data.images[0]; // C·∫≠p nh·∫≠t ·∫£nh theo size v√† m√†u
                        }
                    })
                    .catch(err => {
                        console.error('L·ªói khi c·∫≠p nh·∫≠t ·∫£nh:', err);
                    });
            }
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
        const moTa = document.getElementById("moTa");
        const toggleBtn = document.getElementById("toggleBtn");

        if (moTa && toggleBtn) {
            // Ki·ªÉm tra n·∫øu n·ªôi dung v∆∞·ª£t qu√° chi·ªÅu cao gi·ªõi h·∫°n
            if (moTa.scrollHeight > moTa.clientHeight) {
                toggleBtn.classList.remove("hidden");
            }

            // X·ª≠ l√Ω s·ª± ki·ªán click cho n√∫t "Xem th√™m" / "Thu g·ªçn"
            toggleBtn.addEventListener("click", () => {
                if (moTa.classList.contains("max-h-24")) {
                    moTa.classList.remove("max-h-24", "overflow-hidden");
                    toggleBtn.textContent = "Thu g·ªçn";
                    toggleBtn.setAttribute("aria-label", "Thu g·ªçn m√¥ t·∫£");
                } else {
                    moTa.classList.add("max-h-24", "overflow-hidden");
                    toggleBtn.textContent = "Xem th√™m";
                    toggleBtn.setAttribute("aria-label", "Xem th√™m m√¥ t·∫£");
                }
            });
        }
    });





    // Kh·ªüi ch·∫°y khi DOM s·∫µn s√†ng (sau khi format gi√°)
    document.addEventListener('DOMContentLoaded', () => {
        initRelatedRatings();
    });

    // === Click ·∫£nh ch√≠nh -> m·ªü lightbox ph√≥ng to ===
    document.addEventListener('DOMContentLoaded', () => {
        const mainImage = document.querySelector('.product-img');
        const lb = document.getElementById('lb');
        const lbImg = lb?.querySelector('img');

        if (!mainImage || !lb || !lbImg) return;

        // c·∫£i thi·ªán a11y
        mainImage.setAttribute('tabindex', '0');
        mainImage.setAttribute('draggable', 'false');

        const openLightbox = () => {
            // currentSrc ∆∞u ti√™n ngu·ªìn ·∫£nh th·ª±c t·∫ø (h·ªØu √≠ch v·ªõi srcset), fallback src
            lbImg.src = mainImage.currentSrc || mainImage.src;
            lb.classList.add('show');
        };

        mainImage.addEventListener('click', openLightbox);
        mainImage.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openLightbox();
            }
        });
    });

    // === Click thumbnail -> ƒë·ªïi ·∫£nh l·ªõn ===
    document.querySelectorAll('.thumbnail-img').forEach(thumbnail => {
        thumbnail.addEventListener('click', () => {
            const mainImage = document.querySelector('.product-img');
            if (!mainImage) return;
            mainImage.src = thumbnail.src;
            if (window.innerWidth < 640) {
                mainImage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    });

    // === Click ·∫£nh trong review -> ƒë·ªïi ·∫£nh l·ªõn, double-click m·ªü lightbox ===
    document.querySelectorAll('.media-grid img').forEach(img => {
        img.addEventListener('click', () => {
            const mainImage = document.querySelector('.product-img');
            if (mainImage) {
                mainImage.src = img.dataset.preview || img.src;
                if (window.innerWidth < 640) {
                    mainImage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });

        img.addEventListener('dblclick', () => {
            const lb = document.getElementById('lb');
            const lbImg = lb?.querySelector('img');
            if (lb && lbImg) {
                lbImg.src = img.dataset.preview || img.src;
                lb.classList.add('show');
            }
        });
    });

    // Update cart count
    async function updateCartCount() {
        try {
            const response = await fetch('/api/cart', { credentials: 'include' });
            if (response.ok) {
                const data = await response.json();
                const cartCount = data.chiTietGioHang ? data.chiTietGioHang.length : 0;
                document.getElementById('cart-count').textContent = cartCount;
            } else if (response.status === 401) {
                // Ch∆∞a ƒëƒÉng nh·∫≠p => ƒë·ªÉ 0, KH√îNG redirect
                document.getElementById('cart-count').textContent = 0;
            }
        } catch (error) {
            console.error('Error updating cart count:', error);
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        updateCartCount();
    });

    // Quantity controls
    const minusBtn = document.querySelector('.quantity-btn.minus');
    const plusBtn = document.querySelector('.quantity-btn.plus');
    const quantityInput = document.querySelector('.quantity-input');

    minusBtn.addEventListener('click', () => {
        if (quantityInput.disabled) return;
        if (quantityInput.value > 1) quantityInput.value--;
    });

    plusBtn.addEventListener('click', () => {
        if (quantityInput.disabled) return;
        if (parseInt(quantityInput.value) < parseInt(quantityInput.max)) quantityInput.value++;
    });

    quantityInput.addEventListener('change', () => {
        if (quantityInput.disabled) return;
        if (quantityInput.value < 1) quantityInput.value = 1;
        if (parseInt(quantityInput.value) > parseInt(quantityInput.max)) quantityInput.value = quantityInput.max;
    });

    // Size and Color selection
    const sizeOptions = document.querySelectorAll('.size-option');
    const colorOptions = document.querySelectorAll('.color-option');

    function checkSelections() {
        const selectedSize = document.querySelector('.size-option.active');
        const selectedColor = document.querySelector('.color-option.active');
        const isEnabled = selectedSize && selectedColor;
        quantityInput.disabled = !isEnabled;
        minusBtn.disabled = !isEnabled;
        plusBtn.disabled = !isEnabled;

        updateStockInfo();
    }

    function updateStockInfo() {
        const selectedSize = document.querySelector('.size-option.active');
        const selectedColor = document.querySelector('.color-option.active');
        const stockElement = document.getElementById('dynamic-stock');

        // ==== TH√äM: khi ch∆∞a ch·ªçn -> hi·ªán kho·∫£ng gi√°, ·∫©n old price ====
        if (!selectedSize || !selectedColor) {
            stockElement.textContent = 'Ch·ªçn m√†u & size';
            quantityInput.max = 1;
            showPriceRange(); // <<----
            return;
        }

        const sizeId = selectedSize.dataset.sizeId;
        const colorId = selectedColor.dataset.colorId;
        const sanPhamId = document.querySelector('.add-to-cart').dataset.sanPhamId;

        fetch(`/api/getChiTietSanPham?sanPhamId=${sanPhamId}&sizeId=${sizeId}&colorId=${colorId}`)
            .then(res => res.json())
            .then(data => {
                console.log("D·ªØ li·ªáu t·ªìn kho nh·∫≠n v·ªÅ t·ª´ API:", data);

                // t·ªìn kho
                if (typeof data.soLuongTonKho === 'number') {
                    if (data.soLuongTonKho === 0) {
                        stockElement.textContent = "H·∫øt h√†ng";
                        quantityInput.disabled = true;
                        minusBtn.disabled = true;
                        plusBtn.disabled = true;
                    } else {
                        stockElement.textContent = data.soLuongTonKho;
                        quantityInput.max = data.soLuongTonKho;
                        if (parseInt(quantityInput.value) > data.soLuongTonKho) {
                            quantityInput.value = data.soLuongTonKho;
                        }
                        quantityInput.disabled = false;
                        minusBtn.disabled = false;
                        plusBtn.disabled = false;
                    }
                } else {
                    stockElement.textContent = 'Kh√¥ng kh·∫£ d·ª•ng';
                    quantityInput.max = 1;
                }

                // ==== GI√Å (bi·∫øn th·ªÉ ƒë√£ ch·ªçn) ====
                const priceElement = document.getElementById('detail-price');
                const oldPriceElement = document.getElementById('detail-old-price');

                if (data.gia && priceElement) {
                    priceElement.textContent = formatVND(data.gia);
                }
                if (oldPriceElement) {
                    if (data.oldPrice && data.oldPrice !== data.gia) {
                        oldPriceElement.textContent = formatVND(data.oldPrice);
                        oldPriceElement.style.display = 'inline';
                    } else {
                        oldPriceElement.style.display = 'none';
                    }
                }

                if (data.images && data.images.length > 0) {
                    // Update main product image with first image of the variant
                    const mainImage = document.querySelector('.product-img');
                    if (mainImage) {
                        mainImage.src = data.images[0];
                    }

                    // Update thumbnail images
                    const thumbnailContainer = document.querySelector('.flex.space-x-2.mt-4');
                    if (thumbnailContainer) {
                        // Clear existing thumbnails
                        thumbnailContainer.innerHTML = '';

                        // Add new thumbnails for this variant
                        data.images.forEach(imageUrl => {
                            const thumbnail = document.createElement('img');
                            thumbnail.src = imageUrl;
                            thumbnail.alt = data.tenSanPham || 'Product image';
                            thumbnail.className = 'thumbnail-img rounded cursor-pointer';

                            // Add click event to update main image
                            thumbnail.addEventListener('click', () => {
                                if (mainImage) {
                                    mainImage.src = imageUrl;
                                }
                            });

                            thumbnailContainer.appendChild(thumbnail);
                        });
                    }
                }
            })
            .catch(err => {
                console.error('L·ªói khi g·ªçi API t·ªìn kho:', err);
                stockElement.textContent = 'L·ªói khi t·∫£i t·ªìn kho';
                // fallback: v·∫´n hi·ªán kho·∫£ng gi√° ƒë·ªÉ user kh√¥ng b·ªã "r·ªóng"
                showPriceRange();
            });
    }


    let selectedSizeId = null;
    let selectedColorId = null;

    // Tr·∫£ v·ªÅ danh s√°ch m√†u h·ª£p l·ªá theo size
    function getValidColorsForSize(sizeId) {
        return window.validCombinations
            .filter(c => c.sizeId === sizeId)
            .map(c => c.colorId);
    }

    // Tr·∫£ v·ªÅ danh s√°ch size h·ª£p l·ªá theo m√†u
    function getValidSizesForColor(colorId) {
        return window.validCombinations
            .filter(c => c.colorId === colorId)
            .map(c => c.sizeId);
    }

    sizeOptions.forEach(option => {
        option.addEventListener('click', () => {
            const isActive = option.classList.contains('active');
            sizeOptions.forEach(o => o.classList.remove('active'));

            if (isActive) {
                // Hu·ª∑ ch·ªçn
                selectedSizeId = null;
            } else {
                option.classList.add('active');
                selectedSizeId = option.dataset.sizeId;
            }

            const validColors = getValidColorsForSize(selectedSizeId);

            colorOptions.forEach(color => {
                const id = color.dataset.colorId;

                if (!selectedSizeId) {
                    // N·∫øu hu·ª∑ ch·ªçn size th√¨ enable l·∫°i t·∫•t c·∫£ m√†u
                    color.disabled = false;
                    color.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    const isValid = validColors.includes(id);
                    color.disabled = !isValid;
                    color.classList.toggle('opacity-50', !isValid);
                    color.classList.toggle('cursor-not-allowed', !isValid);

                    if (!isValid && color.classList.contains('active')) {
                        color.classList.remove('active');
                        selectedColorId = null;
                    }
                }
            });

            checkSelections();
        });
    });

    colorOptions.forEach(option => {
        option.addEventListener('click', () => {
            if (option.disabled) return;

            const isActive = option.classList.contains('active');

            // H·ªßy active t·∫•t c·∫£
            colorOptions.forEach(o => o.classList.remove('active'));

            if (isActive) {
                // N·∫øu ƒëang active v√† click l·∫°i => hu·ª∑ ch·ªçn
                selectedColorId = null;
            } else {
                option.classList.add('active');
                selectedColorId = option.dataset.colorId;
            }

            const validSizes = getValidSizesForColor(selectedColorId);
            sizeOptions.forEach(size => {
                const id = size.dataset.sizeId;

                if (!selectedColorId) {
                    // N·∫øu ƒë√£ hu·ª∑ ch·ªçn m√†u => enable l·∫°i t·∫•t c·∫£ size
                    size.disabled = false;
                    size.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    const isValid = validSizes.includes(id);
                    size.disabled = !isValid;
                    size.classList.toggle('opacity-50', !isValid);
                    size.classList.toggle('cursor-not-allowed', !isValid);

                    // N·∫øu size kh√¥ng h·ª£p l·ªá v√† ƒëang active th√¨ hu·ª∑ lu√¥n
                    if (!isValid && size.classList.contains('active')) {
                        size.classList.remove('active');
                        selectedSizeId = null;
                    }
                }
            });

            checkSelections();
        });
    });

    // Thumbnail image click to update main image
    document.querySelectorAll('.thumbnail-img').forEach(thumbnail => {
        thumbnail.addEventListener('click', () => {
            const mainImage = document.querySelector('.product-img');
            mainImage.src = thumbnail.src;
        });
    });

    // Handle Add to Cart and Buy Now
    function handleProductAction(button, action) {
        const selectedSize = document.querySelector('.size-option.active');
        const selectedColor = document.querySelector('.color-option.active');
        const quantity = parseInt(quantityInput.value);

        if (!selectedSize || !selectedColor) {
            Swal.fire({
                icon: 'warning',
                title: 'L·ªói',
                text: 'Vui l√≤ng ch·ªçn k√≠ch c·ª° v√† m√†u s·∫Øc!',
            });
            return;
        }

        if (quantity > parseInt(quantityInput.max)) {
            Swal.fire({
                icon: 'warning',
                title: 'L·ªói',
                text: 'S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho!',
            });
            return;
        }

        try {
            // Get chiTietSanPhamId
            fetch(`/api/getChiTietSanPham?sanPhamId=${button.dataset.sanPhamId}&sizeId=${selectedSize.dataset.sizeId}&colorId=${selectedColor.dataset.colorId}`, { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (!data.id) {
                        Swal.fire({
                            icon: 'error',
                            title: 'L·ªói',
                            text: data.error || 'Kh√¥ng th·ªÉ l·∫•y th√¥ng tin s·∫£n ph·∫©m!',
                        });
                        return;
                    }

                    if (action === 'cart') {
                        // Add to cart
                        const payload = {
                            id: data.id,
                            quantity: quantity
                        };
                        fetch('/api/cart/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                            credentials: 'include'
                        })
                            .then(addResponse => {
                                if (addResponse.ok) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Th√†nh c√¥ng',
                                        text: 'ƒê√£ th√™m v√†o gi·ªè h√†ng!',
                                        showConfirmButton: false,
                                        timer: 1500
                                    });
                                    updateCartCount();
                                } else if (addResponse.status === 401) {
                                    window.location.href = '/customers/login';
                                } else {
                                    addResponse.json().then(errorData => {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'L·ªói',
                                            text: errorData.error || 'C√≥ l·ªói x·∫£y ra khi th√™m v√†o gi·ªè h√†ng!'
                                        });
                                    }).catch(() => {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'L·ªói',
                                            text: 'Kh√¥ng th·ªÉ x·ª≠ l√Ω ph·∫£n h·ªìi m√°y ch·ªß.'
                                        });
                                    });
                                }
                            })
                            .catch(error => {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'L·ªói',
                                    text: 'C√≥ l·ªói x·∫£y ra: ' + error.message,
                                });
                            });
                    } else {
                        // Buy now
                        // Make sure we have a valid price by trying multiple sources and converting to a number
                        // Extract price from data sources, log every source for debugging
                        console.log("Product data:", data);
                        console.log("Price sources: ", {
                            "data.oldPrice": data.oldPrice,
                            "data.gia": data.gia,
                            "data.giaHienThi": data.giaHienThi,
                            "data.giaBan": data.giaBan,
                            "button.dataset.price": button.dataset.price,
                            "button.dataset.productPrice": button.dataset.productPrice,
                            "button.dataset.rawPrice": button.dataset.rawPrice
                        });

                        // Try to get price from all possible sources
                        let price;

                        // First try to use the raw price directly from the button's data attribute
                        if (!isNaN(parseFloat(button.dataset.rawPrice))) {
                            price = parseFloat(button.dataset.rawPrice);
                            console.log("Using button.dataset.rawPrice:", price);
                        }
                        // Then try oldPrice which is most reliable
                        else if (!isNaN(parseFloat(data.oldPrice))) {
                            price = parseFloat(data.oldPrice);
                            console.log("Using data.oldPrice:", price);
                        }
                        // Then try API response data
                        else if (!isNaN(parseFloat(data.gia))) {
                            price = parseFloat(data.gia);
                            console.log("Using data.gia:", price);
                        } else if (!isNaN(parseFloat(data.giaHienThi))) {
                            price = parseFloat(data.giaHienThi);
                            console.log("Using data.giaHienThi:", price);
                        } else if (!isNaN(parseFloat(data.giaBan))) {
                            price = parseFloat(data.giaBan);
                            console.log("Using data.giaBan:", price);
                        }
                        // Last resort, try to parse the formatted price
                        else if (!isNaN(parseFloat(button.dataset.price))) {
                            // Parse the formatted price from button dataset
                            price = parseFloat(button.dataset.price.replace(/[^\d]/g, ''));
                            console.log("Using button.dataset.price:", price);
                        } else {
                            // If still no price, fall back to oldPrice again from the button's data attributes
                            price = parseFloat(button.dataset.productPrice) || 0;
                            console.log("Falling back to button.dataset.productPrice:", price);
                        }

                        const orderItem = {
                            chiTietSanPhamId: data.id,
                            tenSanPham: button.dataset.productName,
                            gia: price, // Use the properly parsed price value
                            soLuong: quantity,
                            urlHinhAnh: button.dataset.productImg,
                            sizeId: selectedSize.dataset.sizeId,
                            colorId: selectedColor.dataset.colorId,
                            sizeName: selectedSize.textContent,
                            colorName: selectedColor.textContent
                        };

                        console.log("Order item being stored:", orderItem);
                        localStorage.setItem('checkoutItem', JSON.stringify(orderItem));
                        window.location.href = '/thanh-toan';
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'L·ªói',
                        text: 'C√≥ l·ªói x·∫£y ra: ' + error.message,
                    });
                });
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: 'C√≥ l·ªói x·∫£y ra: ' + error.message,
            });
        }
    }

    // Add to cart button
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', () => handleProductAction(button, 'cart'));
    });

    // Buy now button
    document.querySelectorAll('.buy-now').forEach(button => {
        button.addEventListener('click', () => handleProductAction(button, 'buy'));
    });

</script>

<!-- WebSocket script for product refresh -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const socket = new SockJS("/ws");
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log("Connected: " + frame);

            const sanPhamId = document.getElementById('sanPhamId').value;
            stompClient.subscribe('/topic/product/' + sanPhamId, function (message) {
                const payload = JSON.parse(message.body);
                if (payload.action === 'refresh') {
                    location.reload();
                }
            });
        });
    });
</script>
</body>

</html>