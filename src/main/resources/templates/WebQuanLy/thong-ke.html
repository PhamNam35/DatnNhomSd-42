<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Thống kê</title>

  <!-- libs -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" th:href="@{/css/admin.css}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script th:src="@{/js/sidebar.js}" defer></script>

  <style>
    :root{
      --primary:#c62828;
      --primary-600:#b71c1c;
      --muted:#667085;
      --ink:#1b2430;
      --card:#ffffff;
      --surface:#faf6f6;
      --line:#f0dede;
    }
    html, body { font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--surface); color:var(--ink); }

    /* ==== LAYOUT ăn khớp sidebar 256px ==== */
    .content{ margin-left:256px; padding:22px; padding-top:80px; }
    /*.custom-navbar{*/
    /*  position:fixed; top:0; right:0; left:256px;*/
    /*  width:calc(100% - 256px); z-index:1029; background:#fff;*/
    /*}*/

    .page-title{ font-weight:800; color:var(--primary); display:flex; align-items:center; gap:10px; margin:12px 0 16px; }
    .page-title i{ color:var(--primary); }

    .grid{ display:grid; grid-template-columns:360px 1fr; gap:22px; align-items:start; }
    .card{ border:1px solid var(--line); background:var(--card); border-radius:14px; box-shadow:0 8px 24px rgba(198,40,40,.08); }
    .stat { display:flex; align-items:center; gap:18px; padding:22px; }
    .stat .icon{ width:54px; height:54px; border-radius:12px; display:flex; align-items:center; justify-content:center; background:#fde7e7; color:var(--primary); font-size:22px; }
    .stat .num{ font-weight:800; font-size:30px; line-height:1; margin-bottom:6px; }
    .stat .lbl{ color: var(--muted); font-weight:600; font-size:13px; }
    .left-col{ display:flex; flex-direction:column; gap:18px; }

    .chart-card{ padding:18px; display:flex; flex-direction:column; }
    .chart-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .chart-head h5{ margin:0; font-weight:800; color:var(--primary); }

    /* Khung chứa donut – chiều cao sẽ được set bằng JS = chiều cao cột trái */
    .ring-wrap{
      position:relative; display:flex; align-items:center; justify-content:center;
      min-height:360px;  /* fallback nếu JS chưa đo kịp */
      padding:8px;
    }
    /* Canvas không phóng quá to */
    #statusDonut{ width:100% !important; height:100% !important; max-width:560px; max-height:100%; }

    .legend{ display:flex; flex-wrap:wrap; gap:12px; margin:6px 6px 2px; }
    .legend .dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; }

    .alert-info{ background:#e9f6ff; border-color:#bee3ff; color:#0b4a7c; }

    /* Filter buttons */
    .filter-btn{ border-color:var(--primary); color:var(--primary); }
    .filter-btn:hover{ background:#fde7e7; color:var(--primary-600); }
    .filter-btn.active{ background:var(--primary); color:#fff; border-color:var(--primary); }


    /* thông báo khi không có dữ liệu chart */
    .empty-chart{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      font-weight:700; color:#b0b0b0;
    }
  </style>
</head>
<body>
<div class="d-flex">
  <!-- SIDEBAR -->
  <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-white w-64"></div>

  <!-- NAVBAR -->
  <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
    <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
  </nav>
  <div class="content">
    <h1 class="page-title"><i class="fa-solid fa-chart-line"></i> Thống kê</h1>

    <!-- trạng thái bộ lọc & lỗi -->
    <div th:if="${filterStatus != null}" class="alert alert-info mb-3" th:text="${filterStatus}"></div>
    <div th:if="${error != null}" class="alert alert-danger mb-3" th:text="${error}"></div>

    <!-- BỘ LỌC -->
    <div class="card mb-3 p-3">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-outline-danger filter-btn" data-filter="day"   onclick="submitFilter('day')">Ngày</button>
          <button type="button" class="btn btn-outline-danger filter-btn" data-filter="7days" onclick="submitFilter('7days')">7 Ngày</button>
          <button type="button" class="btn btn-outline-danger filter-btn" data-filter="month" onclick="submitFilter('month')">Tháng</button>
          <button type="button" class="btn btn-outline-danger filter-btn" data-filter="year"  onclick="submitFilter('year')">Năm</button>
        </div>

        <div class="d-flex align-items-end gap-2">
          <div>
            <label class="form-label mb-1">Từ ngày</label>
            <input id="startDatePicker" class="form-control" placeholder="YYYY-MM-DD">
          </div>
          <div>
            <label class="form-label mb-1">Đến ngày</label>
            <input id="endDatePicker" class="form-control" placeholder="YYYY-MM-DD">
          </div>
          <button class="btn btn-danger" onclick="applyCustomRange()">Áp dụng</button>
          <button class="btn btn-outline-danger" onclick="exportExcel()">Xuất Excel</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- CỘT TRÁI -->
      <div class="left-col" id="leftCol">
        <div class="card stat">
          <div class="icon"><i class="fa-solid fa-bag-shopping"></i></div>
          <div>
            <div class="num" th:text="${sumCustomers ?: 0}">0</div>
            <div class="lbl">Khách Hàng</div>
          </div>
        </div>

        <div class="card stat">
          <div class="icon"><i class="fa-solid fa-cart-shopping"></i></div>
          <div>
            <div class="num" th:text="${sumProducts ?: 0}">0</div>
            <div class="lbl">Sản Phẩm</div>
          </div>
        </div>

        <div class="card stat">
          <div class="icon"><i class="fa-solid fa-file-invoice"></i></div>
          <div>
            <div class="num" th:text="${sumOrders ?: 0}">0</div>
            <div class="lbl">Đơn Hàng</div>
          </div>
        </div>

        <div class="card stat">
          <div class="icon"><i class="fa-solid fa-dollar-sign"></i></div>
          <div>
            <div class="num" th:with="locale='vi_VN'"
                 th:text="${#numbers.formatInteger(sumRevenue, 0, 'POINT')}">0</div>
            <div class="lbl">Tổng Doanh Thu (VND)</div>
          </div>
        </div>
      </div>

      <!-- CỘT PHẢI: Donut trạng thái -->
      <div class="card chart-card">
        <div class="chart-head">
          <h5>Trạng thái đơn hàng</h5>
        </div>
        <div class="ring-wrap" id="ringWrap">
          <canvas id="statusDonut"></canvas>
          <div id="emptyMsg" class="empty-chart" style="display:none;">Không có dữ liệu</div>
        </div>
        <div class="legend" id="legendBox"></div>
      </div>
    </div>
  </div>
</div>

<!-- form ẩn để submit filter -->
<form id="filterForm" method="get" th:action="@{/polyshoe/thong-ke}" style="display:none">
  <input type="hidden" name="boLoc" id="filterInput">
  <input type="hidden" name="ngayBatDau" id="startDateInput">
  <input type="hidden" name="ngayKetThuc" id="endDateInput">
  <input type="hidden" name="topSellingPage" th:value="${topSellingPage}">
  <input type="hidden" name="lowStockPage" th:value="${lowStockPage}">
</form>

<!-- NHÚNG DỮ LIỆU THẬT TỪ BACKEND (KHÔNG DÙNG DỮ LIỆU MẪU) -->
<script th:inline="javascript">
  /*<![CDATA[*/
  // Thymeleaf inline JS tự render Map -> object JS. Nếu null, dùng {}.
  const pieObj = /*[[${trangThaiPercentMap}]]*/ {};
  /*]]>*/
</script>

<script>
  // ===== utils layout: chiều cao donut = chiều cao cột trái =====
  function syncChartHeight(){
    const left = document.getElementById('leftCol');
    const wrap = document.getElementById('ringWrap');
    if(left && wrap){
      // trừ padding top/bottom của chart-card (18px*2) + header ~ 40px
      const adjust = 18*2 + 44;
      const target = Math.max(360, left.offsetHeight - adjust);
      wrap.style.height = target + 'px';
    }
  }

  // flatpickr
  flatpickr("#startDatePicker", { dateFormat: "Y-m-d" });
  flatpickr("#endDatePicker",   { dateFormat: "Y-m-d" });

  // tô nút filter đang chọn
  document.addEventListener('DOMContentLoaded', ()=>{
    const url = new URLSearchParams(window.location.search);
    const f = url.get('boLoc');
    document.querySelectorAll('.filter-btn').forEach(b=>{
      b.classList.toggle('active', b.getAttribute('data-filter')===f);
    });

    syncChartHeight();   // đo lần đầu
    setTimeout(syncChartHeight, 0);       // sau layout
    window.addEventListener('resize', syncChartHeight);
  });

  function submitFilter(type){
    document.getElementById('filterInput').value = type;
    document.getElementById('startDateInput').value = '';
    document.getElementById('endDateInput').value = '';
    document.getElementById('filterForm').submit();
  }

  function applyCustomRange(){
    const s = document.getElementById('startDatePicker').value;
    const e = document.getElementById('endDatePicker').value;
    if(!s || !e){ alert('Vui lòng chọn ngày bắt đầu & kết thúc'); return; }
    if(s > e){ alert('Ngày bắt đầu phải nhỏ hơn hoặc bằng ngày kết thúc'); return; }
    document.getElementById('filterInput').value = 'custom_range';
    document.getElementById('startDateInput').value = s;
    document.getElementById('endDateInput').value = e;
    document.getElementById('filterForm').submit();
  }

  function exportExcel(){
    const params = new URLSearchParams(new FormData(document.getElementById('filterForm'))).toString();
    window.location.href = '/polyshoe/thong-ke/export?' + params;
  }

  // ===== Biểu đồ donut =====
  const labels = pieObj ? Object.keys(pieObj) : [];
  const rawValues = pieObj ? Object.values(pieObj) : [];

  function toNumberSafe(v){
    if (typeof v === 'number') return v;
    if (typeof v === 'string'){
      const n = Number(v.trim().replace('%','').replace(/\s/g,'').replace(/\./g,'').replace(',','.'));
      return isNaN(n) ? 0 : n;
    }
    const n = Number(v);
    return isNaN(n) ? 0 : n;
  }

  const parsed = rawValues.map(toNumberSafe);
  const sumParsed = parsed.reduce((a,b)=>a+b,0);
  const values = (sumParsed > 100) ? parsed.map(v => v * 100 / sumParsed) : parsed;

  const emptyMsg = document.getElementById('emptyMsg');
  const total = values.reduce((a,b)=>a+b,0);

  // Màu đỏ nhạt -> đậm
  const colors = ['#ef9a9a','#e57373','#ef5350','#f44336','#e53935','#d32f2f','#c62828','#b71c1c','#ff8a80','#ff6659'];

  if(!labels.length || total === 0){
    emptyMsg.style.display = 'flex';
    document.getElementById('legendBox').innerHTML = '';
  } else {
    emptyMsg.style.display = 'none';

    const labelPlugin = {
      id:'valueLabels',
      afterDatasetsDraw(chart){
        const {ctx} = chart, ds = chart.data.datasets[0];
        chart.getDatasetMeta(0).data.forEach((arc,i)=>{
          const val = Number(ds.data[i]) || 0;
          if(val <= 0) return;
          const p = arc.getProps(['x','y','startAngle','endAngle','innerRadius','outerRadius'], true);
          const ang = (p.startAngle+p.endAngle)/2, r=(p.innerRadius+p.outerRadius)/2;
          ctx.save();
          ctx.fillStyle='#fff'; ctx.shadowColor='rgba(0,0,0,.25)'; ctx.shadowBlur=2;
          ctx.font='600 12px Inter,Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.fillText(val.toFixed(1) + '%', p.x+Math.cos(ang)*r, p.y+Math.sin(ang)*r);
          ctx.restore();
        });
      }
    };

    const donut = new Chart(document.getElementById('statusDonut'),{
      type:'doughnut',
      data:{
        labels,
        datasets:[{
          data: values,
          backgroundColor: colors.slice(0, labels.length),
          borderWidth:0
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,   // CHO PHÉP FILL THEO CHIỀU CAO RING-WRAP
        cutout:'65%',
        plugins:{
          legend:{display:false},
          tooltip:{ callbacks:{ label:(c)=>`${c.label}: ${(Number(c.parsed)||0).toFixed(1)}%` } }
        }
      },
      plugins:[labelPlugin]
    });

    // legend
    const legendBox=document.getElementById('legendBox');
    legendBox.innerHTML='';
    labels.forEach((lb,i)=>{
      const item=document.createElement('div');
      item.style.display='flex'; item.style.alignItems='center'; item.style.gap='6px';
      item.style.fontWeight='600'; item.style.color='#6b7280';
      item.innerHTML=`<span class="dot" style="background:${colors[i]}"></span>${lb}`;
      legendBox.appendChild(item);
    });
  }
</script>
</body>
</html>