<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Danh sách Phiếu Giảm Giá</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <script th:src="@{/js/sidebar.js}" defer></script>
    <style>
        :root {
            /* Màu chính */
            --primary-color: #DC3545;
            --primary-hover: #C82333;
            --secondary-color: #FFFFFF;
            --secondary-hover: #E9ECEF;
            --accent-color: #000000;
            --accent-hover: #6C757D;
            --border-active: #FF6B6B;

            /* Màu nền */
            --main-background: #F8F9FA;
            --content-background: #ffffff;
            --header-background: #DC3545;

            /* Màu văn bản */
            --text-primary: #000000;
            --text-content: #333333;
            --text-secondary: #6C757D;
            --text-link: #DC3545;
            --text-white: #ffffff;

            /* Màu nút */
            --btn-danger: #DC3545;
            --btn-danger-hover: #C82333;

            /* Màu trạng thái */
            --success-bg: #F8D7DA;
            --success-text: #721C24;
            --warning-bg: #FFF3CD;
            --warning-text: #856404;
            --error-bg: #F8D7DA;
            --error-text: #721C24;

            /* Màu khác */
            --border-color: #dee2e6;
            --light-gray: #f8f9fa;
            --shadow-light: 0 8px 32px rgba(220, 53, 69, 0.1);
            --shadow-medium: 0 12px 40px rgba(220, 53, 69, 0.15);
            --shadow-heavy: 0 20px 60px rgba(220, 53, 69, 0.2);

            --nav-h: 56px;      /* cao navbar (fallback) */
            --header-gap: 0px;  /* sát navbar */
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            background-color: var(--main-background);
            color: var(--text-content);
            margin: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .content {
            margin-left: 250px;
            padding: 32px;
            padding-top: calc(var(--nav-h) + var(--header-gap));
            min-height: 100vh;
            background: var(--content-background);
            transition: all 0.3s ease;
        }

        .content.full-width {
            margin-left: 0;
            padding-top: calc(var(--nav-h) + var(--header-gap));
        }

        .navbar {
            background: var(--content-background);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            right: 0;
            width: calc(100% - 250px);
            z-index: 1000;
        }

        .sticky-header {
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--content-background);
            border: none;
            border-radius: 20px;
            padding: 18px 22px;
            margin: 0 0 20px 0;
            text-align: center;
            box-shadow: var(--shadow-light);
        }

        .sticky-header h2 {
            position: relative;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sticky-header h2::after {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -10px;
            width: 100px;
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }

        .sticky-header h2 i {
            color: var(--accent-color);
            padding: 15px;
            border-radius: 12px;
            font-size: 1.25rem;
        }

        .card {
            background: var(--content-background);
            border: none;
            border-radius: 20px;
            box-shadow: var(--shadow-light);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }

        .search-card {
            background: var(--content-background);
        }

        .card-body {
            padding: 24px;
        }

        #filterForm {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: nowrap;
            border: none;
            border-radius: 16px;
            padding: 16px;
            background: var(--content-background);
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
        }

        #filterForm > .col-md-3, #filterForm > .col-md-2 {
            flex: 1 1 0;
            max-width: 100%;
        }

        .form-label {
            position: absolute;
            left: 1rem;
            top: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            pointer-events: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--content-background);
            padding: 0 0.5rem;
            border-radius: 4px;
        }

        .form-control, .form-select {
            border-radius: 12px;
            border: 2px solid var(--border-color);
            padding: 12px 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            background: var(--content-background);
            color: var(--text-content);
            padding-top: 1.75rem;
            padding-bottom: 0.75rem;
            height: auto;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--border-active);
            box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.1);
            outline: none;
            transform: translateY(-1px);
        }

        .btn {
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--text-white);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            color: var(--text-white);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        }

        .btn-danger {
            background: var(--btn-danger);
            color: var(--text-white);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-danger:hover {
            background: var(--btn-danger-hover);
            color: var(--text-white);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        }

        .btn-outline-info, .btn-outline-success, .btn-outline-primary, .btn-outline-danger {
            background: var(--content-background);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline-info:hover, .btn-outline-success:hover, .btn-outline-primary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: var(--secondary-hover);
            transform: translateY(-2px);
        }

        .btn-outline-danger {
            border-color: var(--error-bg);
            color: var(--error-text);
        }

        .btn-outline-danger:hover {
            border-color: var(--btn-danger);
            color: var(--btn-danger);
            background: var(--error-bg);
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.875rem;
            height: 40px;
            display: inline-flex;
            align-items: center;
        }

        .btn.disabled, .btn:disabled {
            opacity: 0.65;
            cursor: not-allowed;
            box-shadow: none !important;
            transform: none !important;
        }

        .table-responsive {
            border: 1px solid var(--border-color);
            border-radius: 16px;
            background: var(--content-background);
            box-shadow: var(--shadow-light);
            overflow-x: auto;
            overflow-y: visible;
        }

        .table {
            margin-bottom: 0;
            width: auto;
            min-width: 1900px;
            table-layout: auto;
            font-size: 0.9rem;
        }

        .table thead th {
            position: sticky;
            top: 0;
            z-index: 5;
            background: var(--light-gray);
            color: var(--text-primary);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            text-transform: uppercase;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
            padding: 1.5rem 1rem;
            white-space: nowrap;
            text-align: center;
        }

        .table td {
            padding: 1.5rem 1rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-content);
            white-space: nowrap;
            text-align: center;
        }

        .table tbody tr:hover {
            background: var(--accent-hover);
            transform: scale(1.01);
            box-shadow: 0 4px 20px rgba(220, 53, 69, 0.1);
        }

        .table-responsive::-webkit-scrollbar {
            height: 12px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 6px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 6px;
            border: 2px solid var(--light-gray);
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-hover), var(--accent-hover));
        }

        @media (min-width: 1400px) {
            .table {
                min-width: 2100px;
            }
        }

        .badge {
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge.bg-warning {
            background: var(--warning-bg) !important;
            color: var(--warning-text) !important;
            border: 1px solid var(--warning-text);
        }

        .badge.bg-success {
            background: var(--success-bg) !important;
            color: var(--success-text) !important;
            border: 1px solid var(--success-text);
        }

        .badge.bg-secondary {
            background: var(--secondary-hover) !important;
            color: var(--text-secondary) !important;
            border: 1px solid var(--text-secondary);
        }

        .badge.bg-light {
            background: var(--light-gray) !important;
            color: var(--text-content) !important;
            border: 1px solid var(--border-color);
        }

        .pagination {
            gap: 8px;
            margin-top: 18px;
            justify-content: center;
        }

        .page-link {
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background: var(--content-background);
            color: var(--text-primary);
            font-weight: 600;
            padding: 12px 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.1);
        }

        .page-link:hover {
            color: var(--text-white);
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.2);
        }

        .page-item.active .page-link {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-color: var(--primary-color);
            color: var(--text-white);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        }

        .page-item.disabled .page-link {
            background: var(--light-gray);
            color: var(--text-secondary);
            border-color: var(--border-color);
        }

        .toast-container {
            position: fixed;
            top: 14px;
            right: 14px;
            z-index: 1080;
            width: auto;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            border-radius: 14px;
            box-shadow: var(--shadow-medium);
            border: none;
        }

        .text-bg-success {
            background: var(--success-bg) !important;
            color: var(--success-text) !important;
        }

        .text-bg-danger {
            background: var(--error-bg) !important;
            color: var(--error-text) !important;
        }

        .text-bg-info {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color)) !important;
            color: var(--text-white) !important;
        }

        .text-bg-warning {
            background: var(--warning-bg) !important;
            color: var(--warning-text) !important;
        }

        .toast .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
            opacity: 0.8;
        }

        .toast .btn-close:hover {
            opacity: 1;
        }

        @media (max-width: 1200px) {
            #filterForm {
                flex-wrap: wrap;
            }

            #filterForm > .col-md-3, #filterForm > .col-md-2 {
                flex: 1 1 calc(50% - 12px);
            }
        }

        @media (max-width: 768px) {
            .content {
                margin-left: 0;
                padding: 18px;
                padding-top: calc(var(--nav-h) + var(--header-gap));
            }

            .sticky-header {
                padding: 16px;
                border-radius: 14px;
            }

            .sticky-header h2 {
                font-size: 2rem;
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }

            #filterForm > .col-md-3, #filterForm > .col-md-2 {
                flex: 1 1 100%;
            }

            .table {
                min-width: 1100px;
            }

            .btn-sm {
                font-size: 0.8rem;
                padding: 7px 10px;
                height: 38px;
            }
        }

        .flash-update {
            animation: flashBg 0.8s ease;
        }

        @keyframes flashBg {
            0% { background: var(--warning-bg); }
            100% { background: transparent; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: none; }
        }

        .sticky-header, .table-responsive, .card {
            animation: fadeIn 0.6s ease-out;
        }

        .table thead tr.polyshoe-head > th {
            background: var(--primary-color) !important;
            color: var(--text-white) !important;
            border-bottom: 2px solid var(--primary-color) !important;
        }

        .table thead tr.polyshoe-head > th i,
        .table thead tr.polyshoe-head > th a {
            color: inherit !important;
        }
    </style>
</head>
<body>
<div class="d-flex">
    <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-gray-800 text-white w-64"></div>

    <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
        <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
    </nav>

    <div class="content" id="content">
        <!-- Toasts (fixed, góc phải) -->
        <div class="toast-container" id="toastContainer">
            <div class="toast align-items-center text-bg-success border-0" role="alert" id="successToast" aria-live="assertive" aria-atomic="true" th:if="${successMessage}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-check-circle me-2"></i>
                        <span th:text="${successMessage}"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
            <div class="toast align-items-center text-bg-danger border-0" role="alert" id="errorToast" aria-live="assertive" aria-atomic="true" th:if="${errorMessage}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span th:text="${errorMessage}"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
            <div class="toast align-items-center text-bg-info border-0" role="alert" id="infoToast" aria-live="assertive" aria-atomic="true" th:if="${mailMessage}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-info-circle me-2"></i>
                        <span th:text="${mailMessage}"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="sticky-header">
            <h2><i class="fas fa-ticket-alt"></i> Phiếu Giảm Giá</h2>
        </div>

        <!-- Filter -->
        <form method="get" th:action="@{/polyshoe/phieu-giam-gia}" id="filterForm" class="row g-3 search-card">
            <div class="col-md-3">
                <label class="form-label">Tìm kiếm</label>
                <input type="text" name="search" class="form-control" placeholder="Tìm theo mã hoặc tên..." th:value="${search}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Từ ngày</label>
                <input type="datetime-local" name="fromDate" class="form-control" th:value="${fromDate}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Đến ngày</label>
                <input type="datetime-local" name="toDate" class="form-control" th:value="${toDate}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Kiểu</label>
                <select name="type" class="form-select">
                    <option value="">-- Kiểu --</option>
                    <option value="PERCENT" th:selected="${type == 'PERCENT'}">%</option>
                    <option value="CASH" th:selected="${type == 'CASH'}">Tiền mặt</option>
<!--                    <option value="FREESHIP_FULL" th:selected="${type == 'FREESHIP_FULL'}">Freeship toàn phần</option>-->
<!--                    <option value="FREESHIP_CAP" th:selected="${type == 'FREESHIP_CAP'}">Freeship một phần</option>-->
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Trạng thái</label>
                <select name="status" class="form-select">
                    <option value="">-- Trạng thái --</option>
                    <option value="upcoming" th:selected="${status == 'upcoming'}">Sắp diễn ra</option>
                    <option value="active" th:selected="${status == 'active'}">Đang diễn ra</option>
                    <option value="expired" th:selected="${status == 'expired'}">Đã kết thúc</option>
                </select>
            </div>
        </form>

        <!-- Add -->
        <div class="d-flex justify-content-end align-items-center mb-3" th:if="${isAdmin}">
            <a href="/polyshoe/phieu-giam-gia/create" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Tạo Mới
            </a>
        </div>

        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                <tr class="polyshoe-head">
                    <th><i class="fas fa-hashtag me-2"></i>STT</th>
                    <th><i class="fas fa-barcode me-2"></i>MÃ</th>
                    <th><i class="fas fa-tag me-2"></i>TÊN</th>
                    <th><i class="fas fa-percent me-2"></i>KIỂU</th>
                    <th><i class="fas fa-layer-group me-2"></i>LOẠI</th>
                    <th><i class="fas fa-coins me-2"></i>GIÁ TRỊ</th>
                    <th><i class="fas fa-arrow-up me-2"></i>GIÁ TRỊ TỐI ĐA</th>
                    <th><i class="fas fa-arrow-down me-2"></i>ĐIỀU KIỆN</th>
                    <th><i class="fas fa-users me-2"></i>LƯỢT DÙNG</th>
                    <th><i class="fas fa-boxes-stacked me-2"></i>SỐ LƯỢNG</th>
                    <th><i class="fas fa-calendar-plus me-2"></i>NGÀY BẮT ĐẦU</th>
                    <th><i class="fas fa-calendar-minus me-2"></i>NGÀY KẾT THÚC</th>
                    <th><i class="fas fa-info-circle me-2"></i>TRẠNG THÁI</th>
                    <th class="text-center"><i class="fas fa-cogs me-2"></i>HÀNH ĐỘNG</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${vouchers.isEmpty()}">
                    <td colspan="14" class="text-center text-muted py-4">Không có phiếu giảm giá nào.</td>
                </tr>

                <tr th:each="v, stat : ${vouchers}" th:attr="data-voucher-id=${v.id}">
                    <!-- STT liên tục qua trang -->
                    <td><strong th:text="${currentPage * pageSize + stat.index + 1}">1</strong></td>

                    <td th:text="${v.ma}"></td>
                    <td th:text="${v.ten}"></td>
                    <td th:text="${v.loai == 'PERCENT' ? '%' : (v.loai == 'CASH' ? 'Tiền mặt' : v.loai)}"></td>
                    <td th:text="${v.kieuPhieu == 'cong_khai' ? 'Công Khai' : 'Cá Nhân'}"></td>
                    <td th:text="${formats[v.id]['giaTriGiam']}"></td>
                    <td th:text="${formats[v.id]['giaTriGiamToiDa']}"></td>
                    <td th:text="${formats[v.id]['giaTriGiamToiThieu']}"></td>
                    <td th:text="${v.gioiHanSuDung}"></td>

                    <!-- SỐ LƯỢNG (AJAX cập nhật) -->
                    <td>
                        <span class="voucher-qty" th:attr="data-id=${v.id}"
                              th:text="${v.soLuong != null ? v.soLuong : '-'}">-</span>
                    </td>

                    <td th:text="${#temporals.format(v.ngayBatDau, 'dd/MM/yyyy HH:mm')}"></td>
                    <td th:text="${#temporals.format(v.ngayKetThuc, 'dd/MM/yyyy HH:mm')}"></td>
                    <td>
                        <!-- TRẠNG THÁI (AJAX cập nhật) -->
                        <span class="voucher-status" th:attr="data-id=${v.id}">
                            <span th:switch="${getStatus.apply(v)}">
                                <span th:case="'Sắp diễn ra'" class="badge bg-warning text-dark">Sắp diễn ra</span>
                                <span th:case="'Đang diễn ra'" class="badge bg-success">Đang diễn ra</span>
                                <span th:case="'Đã kết thúc'" class="badge bg-secondary">Đã kết thúc</span>
                                <span th:case="'Không xác định'" class="badge bg-light text-dark border">Không xác định</span>
                            </span>
                        </span>
                    </td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <!-- View -->
                            <a th:href="@{'/polyshoe/phieu-giam-gia/view/' + ${v.id}}"
                               class="btn btn-sm btn-outline-success"
                               title="Xem chi tiết phiếu giảm giá">
                                <i class="fas fa-eye"></i>
                            </a>

                            <!-- Edit (chỉ khi Sắp diễn ra) -->
                            <a th:if="${isAdmin and getStatus.apply(v) == 'Sắp diễn ra'}"
                               th:href="@{'/polyshoe/phieu-giam-gia/edit/' + ${v.id}}"
                               class="btn btn-sm btn-outline-info"
                               title="Chỉnh sửa phiếu giảm giá">
                                <i class="fas fa-edit"></i>
                            </a>

                            <!-- Delete -->
                            <button th:if="${isAdmin}"
                                    type="button"
                                    class="btn btn-sm btn-outline-danger delete-btn"
                                    th:classappend="${getStatus.apply(v) != 'Sắp diễn ra'} ? ' disabled'"
                                    th:attr="data-voucher-id=${v.id},
                                             title=${getStatus.apply(v) == 'Sắp diễn ra'} ? 'Xóa phiếu giảm giá' : 'Chỉ được xóa khi trạng thái Sắp diễn ra'">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination (center, no page-size select) -->
        <nav aria-label="Pagination" class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{/polyshoe/phieu-giam-gia(page=${currentPage - 1}, size=${pageSize}, search=${search}, fromDate=${fromDate}, toDate=${toDate}, type=${type}, status=${status})}">
                        <i class="fa-solid fa-chevron-left me-1"></i> Trước
                    </a>
                </li>
                <li class="page-item"
                    th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                    th:classappend="${i == currentPage} ? 'active'">
                    <a class="page-link"
                       th:href="@{/polyshoe/phieu-giam-gia(page=${i}, size=${pageSize}, search=${search}, fromDate=${fromDate}, toDate=${toDate}, type=${type}, status=${status})}"
                       th:text="${i + 1}">1</a>
                </li>
                <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{/polyshoe/phieu-giam-gia(page=${currentPage + 1}, size=${pageSize}, search=${search}, fromDate=${fromDate}, toDate=${toDate}, type=${type}, status=${status})}">
                        Sau <i class="fa-solid fa-chevron-right ms-1"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
<script th:inline="javascript">
    // Đo chiều cao navbar để content sát tuyệt đối
    function setNavHeightVar(){
        const nav = document.querySelector('.custom-navbar');
        const h = nav ? nav.offsetHeight : 56;
        document.documentElement.style.setProperty('--nav-h', h + 'px');
    }
    document.addEventListener('DOMContentLoaded', setNavHeightVar);
    window.addEventListener('resize', setNavHeightVar);

    function showConnectionErrorNotification() {
        let notification = document.getElementById('connectionErrorNotification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'connectionErrorNotification';
            notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 80px; left: 50%; transform: translateX(-50%); z-index: 1050; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                Không thể kết nối real-time
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(notification);
        }
    }

    function hideConnectionErrorNotification() {
        const notification = document.getElementById('connectionErrorNotification');
        if (notification) {
            notification.remove();
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        // Toasts server-side
        const ok = document.getElementById('successToast'); if (ok) new bootstrap.Toast(ok).show();
        const err = document.getElementById('errorToast'); if (err) new bootstrap.Toast(err).show();
        const info = document.getElementById('infoToast'); if (info) new bootstrap.Toast(info).show();

        // Helper toast (fixed top-right)
        function showToast(message, type = 'danger'){
            const container = document.getElementById('toastContainer') || document.body;
            const iconMap = { danger: 'fa-ban', info: 'fa-info-circle', success: 'fa-check-circle', warning: 'fa-triangle-exclamation' };
            const bgMap = { danger: 'text-bg-danger', info: 'text-bg-info', success: 'text-bg-success', warning: 'text-bg-warning' };
            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center ${bgMap[type]||bgMap.danger} border-0`;
            toastEl.setAttribute('role','alert'); toastEl.setAttribute('aria-live','assertive'); toastEl.setAttribute('aria-atomic','true');
            toastEl.innerHTML = ``
                + `<div class="d-flex">`
                + `    <div class="toast-body">`
                + `        <i class="fas ${iconMap[type]||iconMap.danger} me-2"></i>${message}`
                + `    </div>`
                + `    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>`
                + `</div>`;
            container.appendChild(toastEl);
            const t = new bootstrap.Toast(toastEl, { delay: 2500 });
            toastEl.addEventListener('hidden.bs.toast', ()=> toastEl.remove());
            t.show();
        }

        // Auto-submit filter
        const form = document.getElementById("filterForm");
        form.querySelectorAll("select, input[type='datetime-local']").forEach(el => {
            el.addEventListener("change", () => form.submit());
        });

        // Debounce search
        const searchInput = form.querySelector("input[name='search']");
        let typingTimer;
        if (searchInput) {
            searchInput.addEventListener("input", function () {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => form.submit(), 500);
            });
        }

        // ===== Delete flow (SweetAlert2) =====
        const isAdmin = /*[[${isAdmin}]]*/ false;

        // Lấy CSRF (nếu có). Có fallback an toàn.
        let csrfParam = '_csrf', csrfToken = '';
        try {
            csrfParam = /*[['${_csrf.parameterName}']]*/ '_csrf';
            csrfToken = /*[['${_csrf.token}']]*/ '';
        } catch(e) { /* ignore */ }

        if (isAdmin) {
            // Gỡ data-bs-* để tránh kích hoạt modal Bootstrap cũ (nếu còn attribute trong HTML)
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.removeAttribute('data-bs-toggle');
                btn.removeAttribute('data-bs-target');
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    if (this.classList.contains('disabled')) {
                        showToast('Chỉ được xóa khi trạng thái "Sắp diễn ra".', 'warning');
                        return;
                    }

                    const id = this.getAttribute('data-voucher-id') || '';
                    const codeCell = this.closest('tr').querySelector('td:nth-child(2)');
                    const code = codeCell ? codeCell.textContent.trim() : '';

                    await Swal.fire({
                        title: 'Xác nhận xóa phiếu giảm giá',
                        html: `
          <div class="text-start">
            <div class="p-3 rounded mb-3" style="background: var(--light-gray); border: 1px dashed var(--primary-color);">
              <p class="mb-0"><strong>Phiếu:</strong> <span class="text-danger fw-bold">${code}</span></p>
            </div>
            <div class="alert alert-warning mb-0">
              <i class="fa-solid fa-triangle-exclamation me-2"></i>
              Hành động này không thể hoàn tác!
            </div>
          </div>
        `,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Xác nhận xóa',
                        cancelButtonText: 'Hủy',
                        buttonsStyling: false,
                        customClass: {
                            confirmButton: 'btn btn-danger',
                            cancelButton: 'btn btn-secondary ms-2'
                        },
                        reverseButtons: true,
                        focusCancel: true,
                        showLoaderOnConfirm: true,
                        allowOutsideClick: () => !Swal.isLoading(),
                        preConfirm: async () => {
                            try {
                                const params = new URLSearchParams();
                                params.append('id', id);
                                if (csrfToken) params.append(csrfParam, csrfToken);

                                const res = await fetch('/polyshoe/phieu-giam-gia/delete', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                    body: params.toString(),
                                });

                                if (!res.ok) throw new Error('HTTP ' + res.status);
                                return true;
                            } catch (err) {
                                Swal.showValidationMessage('Lỗi khi xóa: ' + (err?.message || 'Không xác định'));
                                return false;
                            }
                        }
                    }).then(result => {
                        if (result.isConfirmed) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Đã xóa',
                                text: `Đã xóa: ${code}`,
                                timer: 1500,
                                showConfirmButton: false
                            });

                            const row = btn.closest('tr');
                            if (row) {
                                row.style.transition = 'opacity .5s ease';
                                row.style.opacity = '0';
                                setTimeout(() => row.remove(), 500);
                            }
                        }
                    });
                });
            });
        }

        // ===== AJAX cập nhật SỐ LƯỢNG & TRẠNG THÁI =====
        function collectVisibleVoucherIds(){
            return Array.from(document.querySelectorAll('tr[data-voucher-id]'))
                .map(tr => tr.getAttribute('data-voucher-id'));
        }

        function renderStatusBadge(status){
            if(status === 'Sắp diễn ra'){
                return '<span class="badge bg-warning">Sắp diễn ra</span>';
            } else if(status === 'Đang diễn ra'){
                return '<span class="badge bg-success">Đang diễn ra</span>';
            } else if(status === 'Đã kết thúc'){
                return '<span class="badge bg-secondary">Đã kết thúc</span>';
            } else {
                return '<span class="badge bg-light">Không xác định</span>';
            }
        }

        async function refreshVoucherSummary(){
            const ids = collectVisibleVoucherIds();
            if (!ids.length) return;

            const url = `/polyshoe/phieu-giam-gia/api/summary?ids=${encodeURIComponent(ids.join(','))}&ts=${Date.now()}`;
            try{
                const res = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' }});
                if(!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                data.forEach(item => {
                    const qtyEl = document.querySelector(`.voucher-qty[data-id="${item.id}"]`);
                    if (qtyEl){
                        const old = qtyEl.textContent.trim();
                        const nextVal = (item.soLuong !== null && item.soLuong !== undefined) ? item.soLuong : '-';
                        if (old !== String(nextVal)){
                            qtyEl.textContent = nextVal;
                            qtyEl.classList.add('flash-update');
                            setTimeout(()=> qtyEl.classList.remove('flash-update'), 1000);
                        }
                    }
                    const stEl = document.querySelector(`.voucher-status[data-id="${item.id}"]`);
                    if (stEl){
                        const newHtml = renderStatusBadge(item.status || 'Không xác định');
                        if (stEl.innerHTML.trim() !== newHtml.trim()){
                            stEl.innerHTML = newHtml;
                            stEl.classList.add('flash-update');
                            setTimeout(()=> stEl.classList.remove('flash-update'), 1000);
                        }
                    }
                });
            }catch(e){
                console.warn('Refresh voucher summary failed:', e);
            }
        }

        let stompClient = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function connectWebSocket() {
            try {
                const socket = new SockJS('/ws');
                stompClient = new window.StompJs.Client({
                    webSocketFactory: () => socket,
                    debug: (str) => console.log('[WebSocket Debug]', str),
                    reconnectDelay: 5000,
                    heartbeatIncoming: 4000,
                    heartbeatOutgoing: 4000,
                });

                stompClient.onConnect = (frame) => {
                    console.log('[WebSocket] Connected to voucher updates');
                    reconnectAttempts = 0;
                    hideConnectionErrorNotification();

                    stompClient.subscribe('/topic/vouchers', (message) => {
                        try {
                            const update = JSON.parse(message.body);
                            handleVoucherUpdate(update);
                        } catch (e) {
                            console.error('[WebSocket] Error parsing voucher update:', e);
                        }
                    });
                };

                stompClient.onStompError = (frame) => {
                    console.error('[WebSocket] STOMP error:', frame);
                    showConnectionErrorNotification();

                    if (reconnectAttempts < maxReconnectAttempts) {
                        setTimeout(() => {
                            reconnectAttempts++;
                            console.log(`[WebSocket] Reconnecting after STOMP error... (${reconnectAttempts}/${maxReconnectAttempts})`);
                            connectWebSocket();
                        }, 2000);
                    }
                };

                stompClient.onWebSocketClose = () => {
                    console.log('[WebSocket] Connection closed');
                    showConnectionErrorNotification();
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        setTimeout(() => {
                            console.log(`[WebSocket] Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`);
                            connectWebSocket();
                        }, 3000 * reconnectAttempts);
                    }
                };

                stompClient.onWebSocketError = (error) => {
                    console.error('[WebSocket] Connection error:', error);
                    showConnectionErrorNotification();
                };

                stompClient.activate();
            } catch (error) {
                console.error('[WebSocket] Connection failed:', error);
                showConnectionErrorNotification();

                if (reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(() => {
                        reconnectAttempts++;
                        console.log(`[WebSocket] Retrying connection... (${reconnectAttempts}/${maxReconnectAttempts})`);
                        connectWebSocket();
                    }, 5000);
                }
            }
        }

        function handleVoucherUpdate(update) {
            console.log('[WebSocket] Voucher update received:', update);

            const { action, voucherId, voucherCode, newStatus, quantity, message } = update;

            const qtyEl = document.querySelector(`.voucher-qty[data-id="${voucherId}"]`);
            if (qtyEl && quantity !== undefined) {
                const oldQty = qtyEl.textContent.trim();
                const newQty = (quantity !== null && quantity !== undefined) ? quantity : '-';
                if (oldQty !== String(newQty)) {
                    qtyEl.textContent = newQty;
                    qtyEl.classList.add('flash-update');
                    setTimeout(() => qtyEl.classList.remove('flash-update'), 1000);
                }
            }

            const statusEl = document.querySelector(`.voucher-status[data-id="${voucherId}"]`);
            if (statusEl && newStatus) {
                const newHtml = renderStatusBadge(newStatus);
                if (statusEl.innerHTML.trim() !== newHtml.trim()) {
                    statusEl.innerHTML = newHtml;
                    statusEl.classList.add('flash-update');
                    setTimeout(() => statusEl.classList.remove('flash-update'), 1000);
                }
            }

            let toastType = 'info';
            let toastMessage = message || 'Cập nhật phiếu giảm giá';

            switch (action) {
                case 'CREATED':
                    toastType = 'success';
                    toastMessage = `Phiếu mới: ${voucherCode}`;
                    setTimeout(() => window.location.reload(), 1500);
                    break;
                case 'UPDATED':
                    toastType = 'info';
                    toastMessage = `Cập nhật: ${voucherCode}`;
                    break;
                case 'DELETED':
                    toastType = 'success';
                    toastMessage = `Đã xóa: ${voucherCode}`;
                    const row = document.querySelector(`tr[data-voucher-id="${voucherId}"]`);
                    if (row) {
                        row.style.transition = 'opacity 0.5s ease';
                        row.style.opacity = '0';
                        setTimeout(() => row.remove(), 500);
                    }
                    break;
                case 'STATUS_CHANGED':
                    toastType = 'info';
                    toastMessage = `${voucherCode}: ${update.oldStatus} → ${newStatus}`;
                    break;
            }

            showToast(toastMessage, toastType);
        }

        connectWebSocket();

        const POLL_MS = 60000;
        let pollTimer = setInterval(refreshVoucherSummary, POLL_MS);

        window.addEventListener('beforeunload', () => {
            if (stompClient && stompClient.connected) {
                stompClient.deactivate();
            }
            clearInterval(pollTimer);
        });
    });

    function replaceCurrencyUnitsInTable(){
        document.querySelectorAll('table.table tbody tr').forEach(tr=>{
            [6,7,8].forEach(idx=>{
                const td = tr.querySelector(`td:nth-child(${idx})`);
                if(!td) return;
                const before = td.textContent;
                let after = before.replace(/₫/g, 'VND');
                after = after.replace(/(\d[\d.\s,]*)\s?đ\b/gi, '$1 VND');
                if (after !== before) td.textContent = after;
            });
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        replaceCurrencyUnitsInTable();
    });
</script>
<script th:if="${successMessage}">
    try { sessionStorage.removeItem('voucherCreateFormState'); } catch(e){}
</script>

<script th:src="@{/js/notification.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>